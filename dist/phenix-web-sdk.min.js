/**
 * Copyright 2016 PhenixP2P Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
define("sdk/Logger",[],function(){"use strict";function a(){}var b=function(){console.log.apply(console,arguments)}||function(){},c=function(){console.error.apply(console,arguments)}||b;return a.prototype.trace=function(){return b(arguments)},a.prototype.debug=function(){return b(arguments)},a.prototype.info=function(){return b(arguments)},a.prototype.warn=function(){return c(arguments)},a.prototype.error=function(){return c(arguments)},a.prototype.fatal=function(){return c(arguments)},a}),define("sdk/MQProtocol",["sdk/Logger","protobuf"],function(a,b){"use strict";function c(c){this._logger=c||new a;var d=b.loadJson(f);d=b.loadJson(g,d),d=b.loadJson(h,d),this._builders=d.build(),this._apiVersion=2}function d(a){for(var b=a.split("."),c=this._builders,d=0;d<b.length-1;d++)if(c=c[b[d]],!c)throw new Error('Unsupported type "'+a+'"');if(c=c[b[b.length-1]],"function"!=typeof c)throw new Error('Unsupported type "'+a+'"');return c}function e(a){if(a&&a.$type&&a.$type.children)for(var b in a.$type.children){var c=a.$type.children[b],d=a[c.name],f=c&&c.element?c.element.resolvedType:null;if(f&&"Message"===f.className&&f.children)a[c.name]=e(d);else if(f&&"Enum"===f.className&&f.children){for(var g=null,h=0;h<f.children.length;h++)if(f.children[h].id===d){g=f.children[h];break}g&&g.name&&(a[c.name]=g.name)}}return a}var f='{"package":"mq","messages":[{"name":"Request","fields":[{"rule":"optional","type":"string","name":"sessionId","id":1},{"rule":"optional","type":"string","name":"requestId","id":2},{"rule":"required","type":"string","name":"type","id":3},{"rule":"optional","type":"string","name":"encoding","id":4},{"rule":"required","type":"bytes","name":"payload","id":5}]},{"name":"Response","fields":[{"rule":"optional","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"requestId","id":2},{"rule":"required","type":"string","name":"type","id":3},{"rule":"optional","type":"string","name":"encoding","id":4},{"rule":"required","type":"bytes","name":"payload","id":5},{"rule":"repeated","type":"double","name":"wallTime","id":6}]},{"name":"Error","fields":[{"rule":"required","type":"string","name":"reason","id":1}]},{"name":"PingPong","fields":[{"rule":"required","type":"uint64","name":"originTimestamp","id":1},{"rule":"optional","type":"uint64","name":"count","id":2}]}]}',g='{"package":"pcast","messages":[{"name":"Authenticate","fields":[{"rule":"optional","type":"uint32","name":"apiVersion","id":9,"options":{"default":0}},{"rule":"required","type":"string","name":"clientVersion","id":1},{"rule":"optional","type":"string","name":"device","id":12},{"rule":"required","type":"string","name":"deviceId","id":2},{"rule":"optional","type":"string","name":"manufacturer","id":13},{"rule":"required","type":"string","name":"platform","id":3},{"rule":"required","type":"string","name":"platformVersion","id":4},{"rule":"required","type":"string","name":"authenticationToken","id":5},{"rule":"optional","type":"string","name":"connectionId","id":6},{"rule":"optional","type":"string","name":"connectionRouteKey","id":10},{"rule":"optional","type":"string","name":"remoteAddress","id":11},{"rule":"optional","type":"string","name":"sessionId","id":7},{"rule":"optional","type":"string","name":"applicationId","id":8}]},{"name":"AuthenticateResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"sessionId","id":2},{"rule":"optional","type":"string","name":"redirect","id":3}]},{"name":"Bye","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"reason","id":2}]},{"name":"ByeResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"SessionDescription","fields":[{"rule":"required","type":"Type","name":"type","id":1,"options":{"default":"Offer"}},{"rule":"required","type":"string","name":"sdp","id":2}],"enums":[{"name":"Type","values":[{"name":"Offer","id":0},{"name":"Answer","id":1}]}]},{"name":"CreateStream","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"optional","type":"string","name":"originStreamId","id":2},{"rule":"repeated","type":"string","name":"options","id":3},{"rule":"repeated","type":"string","name":"tags","id":4},{"rule":"optional","type":"SetRemoteDescription","name":"setRemoteDescription","id":5},{"rule":"optional","type":"CreateOfferDescription","name":"createOfferDescription","id":6},{"rule":"optional","type":"CreateAnswerDescription","name":"createAnswerDescription","id":7}]},{"name":"CreateStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"streamId","id":2},{"rule":"optional","type":"string","name":"instanceRouteKey","id":5},{"rule":"optional","type":"SetRemoteDescriptionResponse","name":"setRemoteDescriptionResponse","id":3},{"rule":"optional","type":"CreateOfferDescriptionResponse","name":"createOfferDescriptionResponse","id":4},{"rule":"optional","type":"CreateAnswerDescriptionResponse","name":"createAnswerDescriptionResponse","id":6}]},{"name":"SetLocalDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"required","type":"SessionDescription","name":"sessionDescription","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"SetLocalDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"SetRemoteDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"required","type":"SessionDescription","name":"sessionDescription","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"SetRemoteDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"SessionDescription","name":"sessionDescription","id":2}]},{"name":"CreateOfferDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"repeated","type":"string","name":"options","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"CreateOfferDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"SessionDescription","name":"sessionDescription","id":2}]},{"name":"CreateAnswerDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"repeated","type":"string","name":"options","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"CreateAnswerDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"SessionDescription","name":"sessionDescription","id":2}]},{"name":"UpdateStreamState","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"required","type":"string","name":"signalingState","id":2},{"rule":"required","type":"string","name":"iceGatheringState","id":3},{"rule":"required","type":"string","name":"iceConnectionState","id":4}]},{"name":"DestroyStream","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"optional","type":"string","name":"reason","id":2}]},{"name":"DestroyStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"StreamStarted","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"repeated","type":"string","name":"tags","id":3}]},{"name":"StreamEnded","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"required","type":"string","name":"reason","id":3}]},{"name":"StreamEndedResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"StreamArchived","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"required","type":"string","name":"uri","id":3}]},{"name":"SessionEnded","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"reason","id":2},{"rule":"required","type":"float","name":"duration","id":3}]},{"name":"IssueAuthenticationToken","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"repeated","type":"string","name":"capabilities","id":3}]},{"name":"IssueAuthenticationTokenResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"authenticationToken","id":2}]},{"name":"IssueStreamToken","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"required","type":"string","name":"sessionId","id":3},{"rule":"optional","type":"string","name":"originStreamId","id":4},{"rule":"repeated","type":"string","name":"capabilities","id":5}]},{"name":"IssueStreamTokenResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"streamToken","id":2}]},{"name":"Stream","fields":[{"rule":"required","type":"string","name":"streamId","id":1}]},{"name":"ListStreams","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"optional","type":"string","name":"start","id":3},{"rule":"required","type":"uint32","name":"length","id":4}]},{"name":"ListStreamsResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"start","id":2},{"rule":"optional","type":"uint32","name":"length","id":3},{"rule":"repeated","type":"Stream","name":"streams","id":4}]},{"name":"TerminateStream","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"required","type":"string","name":"streamId","id":3},{"rule":"optional","type":"string","name":"reason","id":4}]},{"name":"TerminateStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"SetupStream","fields":[{"rule":"required","type":"string","name":"streamToken","id":1},{"rule":"required","type":"CreateStream","name":"createStream","id":2}]},{"name":"SetupStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"CreateStreamResponse","name":"createStreamResponse","id":2}]},{"name":"EndStream","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"optional","type":"string","name":"reason","id":2,"options":{"default":"ended"}}]},{"name":"EndStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"StreamDataQuality","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"required","type":"uint64","name":"timestamp","id":3},{"rule":"required","type":"DataQualityStatus","name":"status","id":4},{"rule":"required","type":"DataQualityReason","name":"reason","id":5}],"enums":[{"name":"DataQualityStatus","values":[{"name":"NoData","id":0},{"name":"AudioOnly","id":1},{"name":"All","id":2}]},{"name":"DataQualityReason","values":[{"name":"None","id":0},{"name":"UploadLimited","id":1},{"name":"DownloadLimited","id":2},{"name":"PublisherLimited","id":3},{"name":"NetworkLimited","id":4}]}]},{"name":"StreamDataQualityResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]}]}',h='{"package":"chat","messages":[{"name":"Room","fields":[{"rule":"optional","type":"string","name":"roomId","id":1},{"rule":"required","type":"string","name":"name","id":2},{"rule":"required","type":"string","name":"description","id":3},{"rule":"required","type":"RoomType","name":"type","id":4},{"rule":"repeated","type":"string","name":"options","id":5}]},{"name":"Stream","fields":[{"rule":"required","type":"StreamType","name":"type","id":1},{"rule":"required","type":"string","name":"uri","id":2},{"rule":"required","type":"TrackState","name":"audioState","id":3},{"rule":"required","type":"TrackState","name":"videoState","id":4}]},{"name":"Member","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"screenName","id":2},{"rule":"required","type":"MemberRole","name":"role","id":3},{"rule":"repeated","type":"Stream","name":"streams","id":4},{"rule":"required","type":"uint64","name":"lastUpdate","id":7}]},{"name":"CreateRoom","fields":[{"rule":"required","type":"Room","name":"room","id":1}]},{"name":"CreateRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"roomId","id":2}]},{"name":"JoinRoom","fields":[{"rule":"required","type":"string","name":"roomId","id":1},{"rule":"required","type":"string","name":"sessionId","id":2},{"rule":"required","type":"Member","name":"member","id":3},{"rule":"repeated","type":"string","name":"options","id":4},{"rule":"required","type":"uint64","name":"timestamp","id":5}]},{"name":"JoinRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"Room","name":"room","id":2},{"rule":"repeated","type":"Member","name":"members","id":3},{"rule":"repeated","type":"string","name":"options","id":4}]},{"name":"UpdateRoom","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"Room","name":"room","id":2},{"rule":"required","type":"uint64","name":"timestamp","id":3}]},{"name":"UpdateRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"UpdateMember","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"Member","name":"member","id":2},{"rule":"repeated","type":"string","name":"options","id":3},{"rule":"required","type":"uint64","name":"timestamp","id":4}]},{"name":"UpdateMemberResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"LeaveRoom","fields":[{"rule":"required","type":"string","name":"roomId","id":1},{"rule":"required","type":"string","name":"sessionId","id":2},{"rule":"required","type":"uint64","name":"timestamp","id":3}]},{"name":"LeaveRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"DestroyRoom","fields":[{"rule":"required","type":"string","name":"roomId","id":1}]},{"name":"DestroyRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"RoomEvent","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"roomId","id":2},{"rule":"required","type":"RoomEventType","name":"eventType","id":3},{"rule":"repeated","type":"Member","name":"members","id":4},{"rule":"optional","type":"Room","name":"room","id":5},{"rule":"repeated","type":"string","name":"options","id":6},{"rule":"required","type":"uint64","name":"timestamp","id":7}]}],"enums":[{"name":"RoomType","values":[{"name":"DirectChat","id":0},{"name":"MultiPartyChat","id":1},{"name":"ModeratedChat","id":2},{"name":"TownHall","id":3}]},{"name":"MemberRole","values":[{"name":"Participant","id":0},{"name":"Moderator","id":1},{"name":"Presenter","id":2},{"name":"Audience","id":3}]},{"name":"RoomEventType","values":[{"name":"MemberJoined","id":0},{"name":"MemberLeft","id":1},{"name":"MemberUpdated","id":2},{"name":"Updated","id":3},{"name":"Ended","id":4}]},{"name":"TrackState","values":[{"name":"Enabled","id":0},{"name":"Disabled","id":1},{"name":"Ended","id":2}]},{"name":"StreamType","values":[{"name":"User","id":0},{"name":"Presentation","id":1}]}]}';return c.prototype.getApiVersion=function(){return this._apiVersion},c.prototype.encode=function(a,b){if("string"!=typeof a)throw new Error("'type' must be a string");if("object"!=typeof b)throw new Error("'data' must be an object");var c=d.call(this,a);return c.encode(b)},c.prototype.decode=function(a,b){if("string"!=typeof a)throw new Error("'type' must be a string");var c=d.call(this,a);return e(c.decode(b))},c}),define("sdk/PCastEndPoint",["sdk/Time"],function(a){"use strict";function b(a,b,c){if("string"!=typeof a)throw new Error('Must pass a valid "version"');if("string"!=typeof b)throw new Error('Must pass a valid "baseUri"');if("object"!=typeof c)throw new Error('Must pass a valid "logger"');this._version=a,this._baseUri=b,this._logger=c}function c(a,b){var c=this;0===a.lastIndexOf("wss:",0)?b.call(c,void 0,a+"/ws"):0===a.lastIndexOf("https:",0)?e.call(c,a+"/pcast/endPoints",function(a,e){if(a)return b(new Error("Failed to resolve an end point",a)),b(a);var g=e.split(",");g.length<1&&b(new Error("Failed to discover end points"));for(var h=!1,i=Number.MAX_VALUE,j="",k=0;k<g.length;k++)d.call(c,g[k],f,function(a,b,d){return i>b&&(c._logger.info("Current closest end point is [%s] with latency of [%s] ms",d,b),i=b,j=d),h},function(a){return j&&i<Number.MAX_VALUE?(h=!0,b.call(c,void 0,j)):void 0})},g):b.call(c,new Error("Uri not supported"))}function d(b,c,d,f){var g=this,h=1,i=function j(b){var i=1,k=a.now();g._logger.info("[%s] Checking end point [%s]",h,b),e.call(g,b,function(e,i){var l=a.now(),m=l-k;return g._logger.info("[%s] End point [%s] latency is [%s] ms",h,b,m),h++,e||!d(b,m,i)?c>=h?(e&&g._logger.info("Retrying after failure to resolve end point [%s]",b,e),j(b)):f(b):void 0},i)};i(b)}function e(b,c,d,f){void 0===f&&(f=1);var g=this,h=new XMLHttpRequest,i="GET",j=b+"?version="+encodeURIComponent(g._version)+"&_="+a.now();if("withCredentials"in h)h.open(i,j,!0);else if("undefined"!=typeof XDomainRequest)h=new XDomainRequest,h.open(i,j);else{var k=new Error("unsupported");k.code="unsupported",c(k)}h.addEventListener("readystatechange",function(){if(4===h.readyState)if(200===h.status)c(void 0,h.responseText);else if(h.status>=500&&h.status<600&&d>=f)e.call(g,b,c,d,f+1);else{g._logger.info("HTTP GET [%s] failed with [%s] [%s]",b,h.status,h.statusText);var a=new Error(0===h.status?"timeout":h.statusText);a.code=h.status,c(a)}}),h.timeout=15e3,h.send()}b.DefaultPCastUri="https://pcast.phenixp2p.com",b.prototype.getBaseUri=function(){return this._baseUri},b.prototype.resolveUri=function(a){return c.call(this,this._baseUri,a)},b.prototype.toString=function(){return"PCastEndPoint["+this._baseUri+"]"};var f=4,g=3;return b}),define("sdk/PCastProtocol",["sdk/MQProtocol","ByteBuffer","phenix-rtc"],function(a,b,c){"use strict";function d(b,c,d,e){if("string"!=typeof b)throw new Error('Must pass a valid "uri"');if("string"!=typeof c)throw new Error('Must pass a valid "deviceId"');if("string"!=typeof d)throw new Error('Must pass a valid "version"');if("object"!=typeof e)throw new Error('Must pass a valid "logger"');this._uri=b,this._deviceId=c,this._version=d,this._logger=e,this._mqProtocol=new a(this._logger),this._logger.info("Connecting to [%s]",b),this._webSocket=new WebSocket(b),this._webSocket.onopen=h.bind(this),this._webSocket.onclose=i.bind(this),this._webSocket.onmessage=j.bind(this),this._webSocket.onerror=k.bind(this),this._nextRequestId=0,this._events={},this._requests={}}function e(a,b,c){var d=(this._nextRequestId++).toString(),e={requestId:d,type:a,payload:this._mqProtocol.encode(a,b)};return this._requests[d]=c,this._webSocket.send(this._mqProtocol.encode("mq.Request",e).toString("base64"))}function f(a){var b=this._events[a];return b||(this._events[a]=b=[]),b}function g(a,b){var c=this._events[a];if(c)for(var d=0;d<c.length;d++)c[d].apply(this,b)}function h(a){this._logger.info("Connected"),g.call(this,"connected")}function i(a){this._logger.info("Disconnected [%s]: [%s]",a.code,a.reason),g.call(this,"disconnected",[a.code,a.reason])}function j(a){this._logger.debug(">> [%s]",a.data);var c=this._mqProtocol.decode("mq.Response",b.wrap(a.data,"base64"));this._logger.info(">> [%s]",c.type);var d=this._mqProtocol.decode(c.type,c.payload);"pcast.AuthenticateResponse"===c.type?this._sessionId=d.sessionId:"pcast.StreamEnded"===c.type?g.call(this,"streamEnded",[d]):"pcast.StreamDataQuality"===c.type&&g.call(this,"dataQuality",[d]);var e=this._requests[c.requestId];e&&(delete this._requests[c.requestId],"mq.Error"===c.type||"ok"!==d.status?e(void 0,d):e(d))}function k(a){this._logger.error("An error occurred",a.data)}return d.prototype.on=function(a,b){if("string"!=typeof a)throw new Error('"eventName" must be a string');if("function"!=typeof b)throw new Error('"handler" must be a function');var c=f.call(this,a);c.push(b)},d.prototype.authenticate=function(a,b){if("string"!=typeof a)throw new Error('"authToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var d={apiVersion:this._mqProtocol.getApiVersion(),clientVersion:this._version,deviceId:this._deviceId,platform:c.browser,platformVersion:c.browserVersion.toString(),authenticationToken:a};return this._sessionId&&(auth.sessionId=this._sessionId),e.call(this,"pcast.Authenticate",d,b)},d.prototype.disconnect=function(){return delete this._sessionId,this._webSocket.close(1e3,"byebye")},d.prototype.bye=function(a,b){if("string"!=typeof a)throw new Error('"reason" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var c={sessionId:this._sessionId,reason:a};return e.call(this,"pcast.Bye",c,b)},d.prototype.createDownloader=function(a,b){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var d=c.browser||"UnknownBrowser",f=d+"-"+(c.browserVersion||0),g={streamToken:a,createStream:{sessionId:this._sessionId,options:["data-quality-notifications"],createOfferDescription:{streamId:"",options:["download","SRTP",d,f],apiVersion:this._mqProtocol.getApiVersion()}}};return e.call(this,"pcast.SetupStream",g,b)},d.prototype.createUploader=function(a,b){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var d=c.browser||"UnknownBrowser",f=d+"-"+(c.browserVersion||0),g={streamToken:a,createStream:{sessionId:this._sessionId,options:["data-quality-notifications"],createOfferDescription:{streamId:"",options:["upload","SRTP",d,f],apiVersion:this._mqProtocol.getApiVersion()}}};return e.call(this,"pcast.SetupStream",g,b)},d.prototype.setAnswerDescription=function(a,b,c){if("string"!=typeof a)throw new Error('"streamId" must be a string');if("string"!=typeof b)throw new Error('"sdp" must be a string');if("function"!=typeof c)throw new Error('"callback" must be a function');var d={streamId:a,sessionDescription:{type:"Answer",sdp:b},apiVersion:this._mqProtocol.getApiVersion()};return e.call(this,"pcast.SetRemoteDescription",d,c)},d.prototype.destroyStream=function(a,b,c){if("string"!=typeof a)throw new Error('"streamId" must be a string');if("string"!=typeof b)throw new Error('"reason" must be a string');if("function"!=typeof c)throw new Error('"callback" must be a function');var d={streamId:a,reason:b};return e.call(this,"pcast.DestroyStream",d,c)},d.prototype.toString=function(){return"PCastProtocol["+this._uri+","+this._webSocket.readyState+"]"},d}),define("sdk/PeerConnectionMonitor",["sdk/Time","phenix-rtc"],function(a,b){"use strict";function c(a,b,c){if("string"!=typeof a)throw new Error('Must pass a valid "name"');if("object"!=typeof b)throw new Error('Must pass a valid "peerConnection"');if("object"!=typeof c)throw new Error('Must pass a valid "logger"');this._name=a,this._peerConnection=b,this._logger=c}function d(c,d,e,l,m){function n(){var g=null;f(d,g,function(f){function g(c,d){switch(b.browser){case"Firefox":if("outbound"===e.direction&&"outboundrtp"===c.type&&void 0!==c.framerateMean&&(h=!0,q=c.framerateMean,void 0!==c.bytesSent)){var f={time:a.now(),value:c.bytesSent};i=!0,r=8*(f.value-s.value)/((f.time-s.time)/1e3),s=f}if("inbound"===e.direction&&"inboundrtp"===c.type&&void 0!==c.framerateMean&&void 0!==c.bytesReceived){var f={time:a.now(),value:c.bytesReceived};i=!0,r=8*(f.value-s.value)/((f.time-s.time)/1e3),s=f}break;default:if("outbound"===e.direction&&void 0!==c.googFrameRateSent){if(h=!0,q=c.googFrameRateSent,void 0!==c.bytesSent){var f={time:a.now(),value:c.bytesSent};i=!0,r=8*(f.value-s.value)/((f.time-s.time)/1e3),s=f}}else if("inbound"===e.direction&&void 0!==c.googFrameRateReceived&&(h=!0,q=c.googFrameRateReceived,void 0!==c.bytesReceived)){var f={time:a.now(),value:c.bytesReceived};i=!0,r=8*(f.value-s.value)/((f.time-s.time)/1e3),s=f}}}var h=!1,i=!1;if(f.forEach)f.forEach(g);else for(var j in f){var k=f[j];g(k,j)}return h&&o._logger.debug("[%s] Current frame rate is [%s] FPS",c,q),i&&o._logger.debug("[%s] Current bit rate is [%s] bps",c,Math.ceil(r)),l()?(!A||"closed"!==d.connectionState&&"failed"!==d.connectionState&&"failed"!==d.iceConnectionState?y&&void 0!==q&&!h?p++:y&&h&&t>=q?p++:z&&void 0!==r&&!i?p++:z&&i&&u>=r?p++:p=0:p++,void(p>=v?m("condition",q,r)?(p=Number.MIN_VALUE,setTimeout(n,w)):o._logger.error("[%s] Failure detected with frame rate [%s] FPS and bit rate [%s] bps: [%s]",c,q,r,f):setTimeout(n,p>0?x:w))):void o._logger.info("[%s] Finished monitoring of peer connection",c)},function(a){m("error",a)})}if("string"!=typeof c)throw new Error('Must pass a valid "name"');if("object"!=typeof d)throw new Error('Must pass a valid "peerConnection"');if("object"!=typeof e)throw new Error('Must pass a valid "options"');if("function"!=typeof l)throw new Error('Must pass a valid "activeCallback"');if("function"!=typeof m)throw new Error('Must pass a valid "monitorCallback"');if("inbound"!==e.direction&&"outbound"!==e.direction)throw new Error("Invalid monitoring direction");var o=this,p=0,q=void 0,r=void 0,s={time:a.now(),value:0},t=e.frameRateThreshold||i,u=e.bitRateThreshold||j,v=e.conditionCountForNotificationThreshold||k,w=e.monitoringInterval||g,x=e.monitoringInterval||h,y=e.hasOwnProperty("monitorFrameRate")?e.monitorFrameRate:!0,z=e.hasOwnProperty("monitorBitRate")?e.monitorBitRate:!0,A=e.hasOwnProperty("monitorState")?e.monitorState:!0;setTimeout(n,w)}function e(a){if("Firefox"===b.browser)return a;var c={};return a.result().forEach(function(a){var b={id:a.id,type:a.type};a.names().forEach(function(c){b[c]=a.stat(c)}),c[b.id]=b}),c}function f(a,c,d,f){switch(b.browser){case"Firefox":return a.getStats(c).then(function(a){var b=e(a);d(b)})["catch"](function(a){f("error",a)});default:return a.getStats(function(a){var b=e(a);d(b)},c,function(a){f("error",a)})}}var g=4e3,h=1500,i=2,j=1e4,k=3;return c.prototype.start=function(a,b,c){return d.call(this,this._name,this._peerConnection,a,b,c)},c.prototype.toString=function(){return"PeerConnectionMonitor[]"},c}),define("sdk/PhenixPCast",["sdk/PCastProtocol","sdk/PCastEndPoint","sdk/PeerConnectionMonitor","sdk/Time","sdk/Logger","phenix-rtc"],function(a,b,c,d,e,f){"use strict";function g(a){a=a||{},this._logger=a.logger||new e,this._baseUri=a.uri||b.DefaultPCastUri,this._deviceId=a.deviceId||"",this._version=E,this._endPoint=new b(this._version,this._baseUri,this._logger),this._screenSharingExtensionId=a.screenSharingExtensionId||F,this._screenSharingAddOn=a.screenSharingAddOn||G,this._screenSharingEnabled=!1,this._shaka=a.shaka||window.shaka,this._status="offline","Chrome"===f.browser&&this._screenSharingExtensionId&&j.call(this),f.addEventListener(window,"unload",function(a){return function(){a.stop()}}(this))}function h(a){var b=this;if("Chrome"===f.browser&&b._screenSharingExtensionId)try{chrome.runtime.sendMessage(b._screenSharingExtensionId,{type:"version"},function(c){c&&"ok"===c.status?(b._logger.info("Screen sharing enabled using version [%s]",c.version),a(!0)):(b._logger.info("Screen sharing NOT available"),a(!1))})}catch(c){c.message&&b._logger.warn(c.message,c),a(!1)}else a("Firefox"===f.browser&&"object"==typeof window.PCastScreenSharing?!0:!1)}function i(){return"https://chrome.google.com/webstore/detail/"+this._screenSharingExtensionId}function j(){for(var a=i.call(this),b=document.getElementsByTagName("link"),c=0;c<b.length;c++)if(b[c].href===a)return;this._logger.debug("Adding Chrome Web Store link [%s]",a);var d=document.createElement("link");d.rel="chrome-webstore-item",d.href=a,document.getElementsByTagName("head")[0].appendChild(d)}function k(a){var b=this,c=i.call(this);try{chrome.webstore.install(c,function(){return a("ok")},function(c){if(c){if(c.match(/cancelled/gi))return b._logger.info("User cancelled screen sharing"),a("cancelled",new Error(c));b._logger.warn(c)}return a("failed",new Error(c||"failed"))})}catch(d){d.message&&b._logger.warn(d.message),a("failed",d)}}function l(a){try{var b,c={"PCast Screen Sharing":{URL:this._screenSharingAddOn.url,IconURL:this._screenSharingAddOn.iconUrl,Hash:this._screenSharingAddOn.hash,toString:function(){return this.URL}}},d=I,e=function(){b&&clearInterval(b),a("ok")},f=function(){b&&clearInterval(b),a("failed",new Error("failed"))};b=setInterval(function(){return"object"==typeof window.PCastScreenSharing?e():d--<0?f():void 0},H),InstallTrigger.install(c,function(a,b){0===b?e():f()})}catch(g){g.message&&this._logger.warn(g.message),a("failed",g)}}function m(a,b){var c=this;switch(f.browser){case"Chrome":try{chrome.runtime.sendMessage(c._screenSharingExtensionId,{type:"get-desktop-media"},function(c){if("ok"!==c.status)return b(c.status,void 0,new Error(c.status));var d={video:{}};"object"==typeof a&&"object"==typeof a.screen&&(d.video=a.screen),"object"!=typeof d.video.mandatory&&(d.video.mandatory={}),d.video.mandatory.chromeMediaSource="desktop",d.video.mandatory.chromeMediaSourceId=c.streamId,b("ok",d,void 0)})}catch(d){d.message&&c._logger.warn(d.message),b("failed",void 0,d)}break;case"Firefox":var e={video:{}};"object"==typeof a&&"object"==typeof a.screen&&(e.video=a.screen),e.video.mediaSource="window",b("ok",e,void 0);break;default:b("not-supported",void 0,new Error("not-supported"))}}function n(a,b){var c=this;if(a.screen)if(c._screenSharingEnabled)m.call(c,a,b);else{var d=function(d){return"cancelled"===d?b(d,"cancelled"):"ok"!==d?b(d,void 0,new Error("screen-sharing-installation-failed")):void h.call(c,function(e){return c._screenSharingEnabled=e,c._screenSharingEnabled?void m.call(c,a,b):b(d,void 0,new Error("screen-sharing-installation-failed"))})};switch(f.browser){case"Chrome":k.call(c,d);break;case"Firefox":l.call(c,d);break;default:b("not-supported",void 0,new Error("not-supported"))}}else{var e={audio:a.audio||!1,video:a.video||!1};b("ok",e,void 0)}}function o(a,b){var c=this,d=function(a){c._gumStreams.push(a),b(c,"ok",a)},e=function(){b(c,"cancelled",null)},g=function(a){"unavailable"===a.code?b(c,"conflict",void 0,a):"permission-denied"===a.message?b(c,"permission-denied",void 0,a):"PermissionDeniedError"===a.name?b(c,"permission-denied",void 0,a):"InternalError"===a.name&&"Starting video failed"===a.message?b(c,"conflict",void 0,a):"SourceUnavailableError"===a.name?b(c,"conflict",void 0,a):"SecurityError"===a.name&&"The operation is insecure."===a.message?b(c,"permission-denied",void 0,a):b(c,"failed",void 0,a)};n.call(c,a,function(a,b,c){if("cancelled"===a)return e();if("ok"!==a)return g(c);try{f.getUserMedia(b,d,g)}catch(h){g(h)}})}function p(){var a=this;this._connected=!0,a._stopped||a._protocol.authenticate(a._authToken,function(b,c){a._authenticationCallback&&(c?(a._logger.warn("Failed to authenticate",c),y.call(a,"offline"),a._authenticationCallback.call(a,a,"unauthorized",""),a.stop("unauthorized")):(y.call(a,"online"),a._authenticationCallback.call(a,a,b.status,b.sessionId)))})}function q(){this._connected=!1,y.call(this,"offline")}function r(a){switch(a){case"":case"none":case"ended":return"ended";case"server-error":case"not-ready":case"error":
return"failed";case"censored":return"censored";case"maintenance":return"maintenance";case"capacity":return"capacity";case"app-background":return"app-background";default:return"custom"}}function s(a){var b=a.streamId,c=a.reason;return u.call(this,b,c)}function t(a){var b=a.streamId,c=a.status,d=a.reason,e=this._renderer[b];e&&"function"==typeof e.dataQualityChangedCallback&&e.dataQualityChangedCallback(e,c,d);var f=this._publishers[b];f&&"function"==typeof f.dataQualityChangedCallback&&f.dataQualityChangedCallback(f,c,d)}function u(a,b){this._logger.info("[%s] Stream ended with reason [%s]",a,b);var c=this._mediaStreams[a];c&&"function"==typeof c.streamEndedCallback&&c.streamEndedCallback(c,r(b),b),delete this._mediaStreams[a];var d=this._renderer[a];d&&(this._logger.info("[%s] stop media stream",a),c.stop()),delete this._renderer[a];var e=this._publishers[a];e&&"function"==typeof e.publisherEndedCallback&&e.publisherEndedCallback(e,r(b),b),delete this._publishers[a];var f=this._peerConnections[a];f&&"closed"!==f.signalingState&&(this._logger.info("[%s] close peer connection",a),f.close()),delete this._peerConnections[a]}function v(a,b,d,e){function g(){function a(a){h._logger.info("Created answer [%s]",a.sdp),h._protocol.setAnswerDescription(b,a.sdp,function(a,g){function j(){var a=/(b=AS:([0-9]*)[\n\r]*)/gi,g=/(mid:video)([\n\r]*)/gi;h._logger.info("Set local description (answer)");var j=0,l=a.exec(d);l&&l.length>=3&&(j=1e3*l[2]);var m={getStreamId:function(){return b},hasEnded:function(){switch(k.iceConnectionState){case"new":case"checking":case"connected":case"completed":return!1;case"disconnected":case"failed":case"closed":return!0;default:return!0}},stop:function(a){"closed"!==k.signalingState&&k.close(),i||(h._protocol.destroyStream(b,a||"",function(a,c){return c?void h._logger.error("[%s] failed to destroy stream",b):void h._logger.info("[%s] destroyed stream",b)}),i=!0)},setPublisherEndedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.publisherEndedCallback=a},setDataQualityChangedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.dataQualityChangedCallback=a},limitBandwidth:function(b){if("number"!=typeof b)throw new Error('"bandwidthLimit" must be a number');var c=j?Math.min(b,j):b,d=k.remoteDescription;h._logger.info("Changing bandwidth limit to [%s]",c);var e=d.sdp.replace(a,"");e=e.replace(g,function(a,b,d,e,f){return[b,d,"b=AS:",Math.ceil(c/1e3),d].join("")});var i=new f.RTCSessionDescription({type:d.type,sdp:e});return k.setRemoteDescription(i),{dispose:function(){k.setRemoteDescription(d)}}},monitor:function n(a,d){if("object"!=typeof a)throw new Error('"options" must be an object');if("function"!=typeof d)throw new Error('"callback" must be a function');var n=new c(b,k,h._logger);a.direction="outbound",n.start(a,function(){return h._publishers[b]===m},function(a){return h._logger.warn("[%s] Publisher triggered monitor condition for [%s]",b,a),d(m,"client-side-failure",a)})}};h._publishers[b]=m,e.call(h,m)}if(g)return h._logger.warn("Failed to set answer description",g),l();var m=new f.RTCSessionDescription({type:"answer",sdp:a.sessionDescription.sdp});k.setLocalDescription(m,j,l)})}h._logger.info("Set remote description (offer)"),k.createAnswer(a,l,C)}var h=this,i=!1,j=!1,k=new f.RTCPeerConnection(A,B);h._peerConnections[b]=k,k.addStream(a);var l=function(){j||(j=!0,i=!0,delete h._peerConnections[b],"closed"!==k.signalingState&&k.close(),e.call(h,void 0,"failed"))},m=new f.RTCSessionDescription({type:"offer",sdp:d});k.setRemoteDescription(m,g,l);var n=function(a){var c=a.candidate;c?h._logger.debug("[%s] ICE candidate (publisher): [%s] [%s] [%s]",b,c.sdpMid,c.sdpMLineIndex,c.candidate):h._logger.info("[%s] ICE candidate discovery complete (publisher)",b)};f.addEventListener(k,"icecandidate",n)}function w(a,b,d){function e(){function b(b){g._logger.info("Created answer [%s]",b.sdp),g._protocol.setAnswerDescription(a,b.sdp,function(a,b){function c(){g._logger.debug("Set local description (answer)")}if(b)return g._logger.warn("Failed to set answer description",b),l();var d=new f.RTCSessionDescription({type:"answer",sdp:a.sessionDescription.sdp});j.setLocalDescription(d,c,l)})}g._logger.debug("Set remote description (offer)"),j.createAnswer(b,l,D)}var g=this,h=!1,i=!1,j=new f.RTCPeerConnection(A,B);g._peerConnections[a]=j;var k=function(b){if(!h){var e=b.stream;if(!e)return h=!0,g._logger.warn("[%s] No remote stream",a),d.call(g,void 0,"failed");g._logger.info("[%s] Got remote stream",a);var k={createRenderer:function(){return{start:function(b){return this.element=f.attachMediaStream(b,e),g._renderer[a]=this,this.element},stop:function(){this.element&&this.element.pause(),delete g._renderer[a]},setDataQualityChangedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.dataQualityChangedCallback=a}}},setStreamEndedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamEndedCallback=a},setStreamErrorCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamErrorCallback=a},stop:function(c){"closed"!==j.signalingState&&j.close();var d=b.stream;z(d),i||(g._protocol.destroyStream(a,c||"",function(b,c){return c?void g._logger.error("[%s] failed to destroy stream",a):void g._logger.info("[%s] destroyed stream",a)}),i=!0)},monitor:function l(b,d){if("object"!=typeof b)throw new Error('"options" must be an object');if("function"!=typeof d)throw new Error('"callback" must be a function');var l=new c(a,j,g._logger);b.direction="inbound",l.start(b,function(){return g._mediaStreams[a]===k},function(b){return g._logger.warn("[%s] Media stream triggered monitor condition for [%s]",a,b),d(k,"client-side-failure",b)})}};g._mediaStreams[a]=k,d.call(g,k)}},l=function(){h||(h=!0,delete g._peerConnections[a],"closed"!==j.signalingState&&j.close(),d.call(g,void 0,"failed"))};f.addEventListener(j,"addstream",k);var m=function(b){var c=b.candidate;c?g._logger.debug("[%s] ICE candidate (viewer): [%s] [%s] [%s]",a,c.sdpMid,c.sdpMLineIndex,c.candidate):g._logger.info("[%s] ICE candidate discovery complete (viewer)",a)};f.addEventListener(j,"icecandidate",m);var n=new f.RTCSessionDescription({type:"offer",sdp:b});j.setRemoteDescription(n,e,l)}function x(a,b,c){var d=this;if(!d._shaka)return d._logger.warn("[%s] No live player available, e.g. Shaka 2",a),c.call(d,void 0,"live-player-missing");if(!d._shaka.Player.isBrowserSupported())return d._logger.warn("[%s] Shaka does not support this browser",a),c.call(d,void 0,"browser-unsupported");var e=b.match("a=x-playlist:([^\n]*[.]mpd)");if(!e||e.length<2)return d._logger.warn("[%s] Offer does not contain a DASH manifest",a,b),c.call(d,void 0,"failed");var f=d._shaka,g=encodeURI(e[1]).replace(/[#]/g,"%23"),h=!1,i=function(b){d._logger.error("[%s] Live stream error event [%s]",a,b.detail),j.streamErrorCallback&&j.streamErrorCallback(j,"shaka",b.detail)},j={createRenderer:function(){return{start:function(b){this.player=new f.Player(b),d._renderer[a]=this,this.player.addEventListener("error",i);this.player.load(g).then(function(){d._logger.info("[%s] Live stream has been loaded",a)})["catch"](function(b){d._logger.error("[%s] Error while loading live stream [%s]",a,b.code,b),j.streamErrorCallback&&j.streamErrorCallback(j,"shaka",b.code,b)});return b},stop:function(){if(this.player){var b=!1,c=function(){if(!b&&j.streamEndedCallback){b=!0;var a="";j.streamEndedCallback(j,r(a),a)}};this.player.destroy().then(function(){d._logger.info("[%s] Live stream has been destroyed",a)}).then(function(){c()})["catch"](function(b){d._logger.error("[%s] Error while destroying live stream [%s]",a,b.code,b),c(),j.streamErrorCallback&&j.streamErrorCallback(j,"shaka",b.code,b)})}delete d._renderer[a]},setDataQualityChangedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.dataQualityChangedCallback=a}}},setStreamEndedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamEndedCallback=a},setStreamErrorCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamErrorCallback=a},stop:function(b){h||(d._protocol.destroyStream(a,b||"",function(b,c){return c?void d._logger.error("[%s] failed to destroy stream",a):void d._logger.info("[%s] destroyed stream",a)}),h=!0)},monitor:function(a,b){if("object"!=typeof a)throw new Error('"options" must be an object');if("function"!=typeof b)throw new Error('"callback" must be a function')}};c.call(d,j)}function y(a){if(this._status!==a)switch(this._status=a,a){case"connecting":break;case"offline":this._offlineCallback.call(this);break;case"online":this._onlineCallback.call(this)}}function z(a){if(a&&"function"==typeof a.getTracks)for(var b=a.getTracks(),c=0;c<b.length;c++){var d=b[c];d.stop()}}var A={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}]},B={optional:[{DtlsSrtpKeyAgreement:!1},{RtpDataChannels:!1}]},C={mandatory:{OfferToReceiveVideo:!1,OfferToReceiveAudio:!1}},D={mandatory:{OfferToReceiveVideo:!0,OfferToReceiveAudio:!0}},E="2016-09-30T19:34:10Z",F="icngjadgidcmifnehjcielbmiapkhjpn",G={url:"https://addons.mozilla.org/firefox/downloads/file/474686/pcast_screen_sharing-1.0.3-an+fx.xpi",iconUrl:"https://phenixp2p.com/public/images/phenix-logo-unicolor-64x64.png",hash:"sha256:4972e9718ea7f7c896abc12d1a9e664d5f3efe498539b082ab7694f9d7af4f3b"},H=100,I=450;return g.prototype.getBaseUri=function(){return this._endPoint.getBaseUri()},g.prototype.getStatus=function(){return this._status},g.prototype.start=function(b,c,d,e){if("string"!=typeof b)throw new Error('"authToken" must be a string');if("function"!=typeof c)throw new Error('"authenticationCallback" must be a function');if("function"!=typeof d)throw new Error('"onlineCallback" must be a function');if("function"!=typeof e)throw new Error('"offlineCallback" must be a function');if(this._started)throw new Error('"Already started"');this._stopped=!1,this._started=!0,this._authToken=b,this._authenticationCallback=c,this._onlineCallback=d,this._offlineCallback=e,this._status="connecting",this._peerConnections={},this._mediaStreams={},this._renderer={},this._publishers={},this._gumStreams=[];var f=this;h.call(f,function(b){f._screenSharingEnabled=b,f._endPoint.resolveUri(function(b,c){if(b){switch(f._logger.error("Failed to connect to [%s]",f._baseUri,b),y.call(f,"offline"),b.code){case 0:f._authenticationCallback.call(f,f,"network-unavailable","");break;case 503:f._authenticationCallback.call(f,f,"capacity","");break;default:f._authenticationCallback.call(f,f,"failed","")}return f._stopped=!0,void(f._started=!1)}f._logger.info("Discovered end point [%s]",c),f._protocol=new a(c,f._deviceId,f._version,f._logger),f._protocol.on("connected",p.bind(f)),f._protocol.on("disconnected",q.bind(f)),f._protocol.on("streamEnded",s.bind(f)),f._protocol.on("dataQuality",t.bind(f))})})},g.prototype.stop=function(){if(this._started){this._stopped=!0,this._started=!1,delete this._authenticationCallback;try{var a="";for(var b in this._mediaStreams)if(this._mediaStreams.hasOwnProperty(b)){var c=this._mediaStreams[b];u.call(this,b,a),c.stop(a)}for(var b in this._renderer)if(this._renderer.hasOwnProperty(b)){var d=this._renderer[b];d.stop(a)}for(var b in this._publishers)if(this._publishers.hasOwnProperty(b)){var e=this._publishers[b];u.call(this,b,a),e.stop(a)}for(var b in this._peerConnections)this._peerConnections.hasOwnProperty(b)&&u.call(this,b,a);for(var f=0;f<this._gumStreams.length;f++)for(var g=this._gumStreams[f].getTracks(),h=0;h<g.length;h++)g[h].stop()}finally{this._protocol&&this._protocol.disconnect()}}},g.prototype.getUserMedia=function(a,b){if("object"!=typeof a)throw new Error('"options" must be an object');if("function"!=typeof b)throw new Error('"callback" must be a function');return o.call(this,a,b)},g.prototype.publish=function(a,b,c,d){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("object"!=typeof b)throw new Error('"mediaStreamToPublish" must be an object');if("function"!=typeof c)throw new Error('"callback" must be a function');if(d=d||[],!Array.isArray(d))throw new Error('"tags" must be an array');var e=this;this._protocol.createUploader(a,function(a,d){if(d)switch(e._logger.warn("Failed to create uploader",d),d.status){case"capacity":return c.call(e,e,d.status);default:return c.call(e,e,"failed")}else{var f=a.createStreamResponse.streamId,g=a.createStreamResponse.createOfferDescriptionResponse.sessionDescription.sdp;v.call(e,b,f,g,function(a,b){b?c.call(e,e,"failed",null):c.call(e,e,"ok",a)})}})},g.prototype.subscribe=function(a,b){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var c=this;this._protocol.createDownloader(a,function(a,d){if(!d){var e=a.createStreamResponse.streamId,f=a.createStreamResponse.createOfferDescriptionResponse.sessionDescription.sdp,g=w;return f.match(/a=x-playlist:/)&&(g=x),g.call(c,e,f,function(a,d){d?b.call(c,c,"failed",null):b.call(c,c,"ok",a)})}switch(c._logger.warn("Failed to create downloader",d),d.status){case"capacity":case"stream-ended":case"origin-stream-ended":case"streaming-not-available":return b.call(c,c,d.status);default:return b.call(c,c,"failed")}})},g.prototype.toString=function(){return"PhenixPCast["+this._sessionId+","+this._protocol.toString()+"]"},g}),define("sdk/Time",[],function(){"use strict";function a(){this._version=version,this._baseUri=baseUri}return a.now=function(){return Date.now?function(){return Date.now()}:function(){return(new Date).getTime()}}(),a}),define("phenix-web-sdk",["sdk/PhenixPCast","sdk/Logger"],function(a,b){return window.PhenixPCast=a,{PCast:a,Logger:b}});