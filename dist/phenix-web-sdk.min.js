/**
 * Copyright 2016 PhenixP2P Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
define("sdk/MQProtocol",["protobuf"],function(a){"use strict";function b(){var b=a.loadJson(d);b=a.loadJson(e,b),this._builders=b.build(),this._apiVersion=1}function c(a){for(var b=a.split("."),c=this._builders,d=0;d<b.length-1;d++)if(c=c[b[d]],!c)throw new Error('Unsupported type "'+a+'"');if(c=c[b[b.length-1]],"function"!=typeof c)throw new Error('Unsupported type "'+a+'"');return c}var d='{"package":"mq","messages":[{"name":"Request","fields":[{"rule":"optional","type":"string","name":"sessionId","id":1},{"rule":"optional","type":"string","name":"requestId","id":2},{"rule":"required","type":"string","name":"type","id":3},{"rule":"optional","type":"string","name":"encoding","id":4},{"rule":"required","type":"bytes","name":"payload","id":5}]},{"name":"Response","fields":[{"rule":"optional","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"requestId","id":2},{"rule":"required","type":"string","name":"type","id":3},{"rule":"optional","type":"string","name":"encoding","id":4},{"rule":"required","type":"bytes","name":"payload","id":5},{"rule":"repeated","type":"double","name":"wallTime","id":6}]},{"name":"Error","fields":[{"rule":"required","type":"string","name":"reason","id":1}]},{"name":"PingPong","fields":[{"rule":"required","type":"uint64","name":"originTimestamp","id":1},{"rule":"optional","type":"uint64","name":"count","id":2}]}]}',e='{"package": "pcast","messages": [{"name": "Authenticate","fields": [{"rule": "optional","type": "uint32","name": "apiVersion","id": 9,"options": {"default": 0}},{"rule": "required","type": "string","name": "clientVersion","id": 1},{"rule": "required","type": "string","name": "deviceId","id": 2},{"rule": "required","type": "string","name": "platform","id": 3},{"rule": "required","type": "string","name": "platformVersion","id": 4},{"rule": "required","type": "string","name": "authenticationToken","id": 5},{"rule": "optional","type": "string","name": "connectionId","id": 6},{"rule": "optional","type": "string","name": "connectionRouteKey","id": 10},{"rule": "optional","type": "string","name": "sessionId","id": 7},{"rule": "optional","type": "string","name": "applicationId","id": 8}]},{"name": "AuthenticateResponse","fields": [{"rule": "required","type": "string","name": "status","id": 1},{"rule": "optional","type": "string","name": "sessionId","id": 2},{"rule": "optional","type": "string","name": "redirect","id": 3}]},{"name": "Bye","fields": [{"rule": "required","type": "string","name": "sessionId","id": 1}]},{"name": "ByeResponse","fields": [{"rule": "required","type": "string","name": "status","id": 1}]},{"name": "SessionDescription","fields": [{"rule": "required","type": "Type","name": "type","id": 1,"options": {"default": "Offer"}},{"rule": "required","type": "string","name": "sdp","id": 2}],"enums": [{"name": "Type","values": [{"name": "Offer","id": 0},{"name": "Answer","id": 1}]}]},{"name": "CreateStream","fields": [{"rule": "required","type": "string","name": "sessionId","id": 1},{"rule": "optional","type": "string","name": "originStreamId","id": 2},{"rule": "repeated","type": "string","name": "options","id": 3},{"rule": "repeated","type": "string","name": "tags","id": 4},{"rule": "optional","type": "SetRemoteDescription","name": "setRemoteDescription","id": 5},{"rule": "optional","type": "CreateOfferDescription","name": "createOfferDescription","id": 6}]},{"name": "CreateStreamResponse","fields": [{"rule": "required","type": "string","name": "status","id": 1},{"rule": "optional","type": "string","name": "streamId","id": 2},{"rule": "optional","type": "string","name": "instanceRouteKey","id": 5},{"rule": "optional","type": "SetRemoteDescriptionResponse","name": "setRemoteDescriptionResponse","id": 3},{"rule": "optional","type": "CreateOfferDescriptionResponse","name": "createOfferDescriptionResponse","id": 4}]},{"name": "SetRemoteDescription","fields": [{"rule": "required","type": "string","name": "streamId","id": 1},{"rule": "required","type": "SessionDescription","name": "sessionDescription","id": 2},{"rule": "optional","type": "uint32","name": "apiVersion","id": 3,"options": {"default": 0}}]},{"name": "SetRemoteDescriptionResponse","fields": [{"rule": "required","type": "string","name": "status","id": 1},{"rule": "optional","type": "SessionDescription","name": "sessionDescription","id": 2}]},{"name": "CreateOfferDescription","fields": [{"rule": "required","type": "string","name": "streamId","id": 1},{"rule": "repeated","type": "string","name": "options","id": 2},{"rule": "optional","type": "uint32","name": "apiVersion","id": 3,"options": {"default": 0}}]},{"name": "CreateOfferDescriptionResponse","fields": [{"rule": "required","type": "string","name": "status","id": 1},{"rule": "required","type": "SessionDescription","name": "sessionDescription","id": 2}]},{"name": "UpdateStreamState","fields": [{"rule": "required","type": "string","name": "streamId","id": 1},{"rule": "required","type": "string","name": "signalingState","id": 2},{"rule": "required","type": "string","name": "iceGatheringState","id": 3},{"rule": "required","type": "string","name": "iceConnectionState","id": 4}]},{"name": "DestroyStream","fields": [{"rule": "required","type": "string","name": "streamId","id": 1},{"rule": "optional","type": "string","name": "reason","id": 2}]},{"name": "DestroyStreamResponse","fields": [{"rule": "required","type": "string","name": "status","id": 1}]},{"name": "StreamStarted","fields": [{"rule": "required","type": "string","name": "sessionId","id": 1},{"rule": "required","type": "string","name": "streamId","id": 2},{"rule": "repeated","type": "string","name": "tags","id": 3}]},{"name": "StreamEnded","fields": [{"rule": "required","type": "string","name": "sessionId","id": 1},{"rule": "required","type": "string","name": "streamId","id": 2},{"rule": "required","type": "string","name": "reason","id": 3}]},{"name": "SetupStream","fields": [{"rule": "required","type": "string","name": "streamToken","id": 1},{"rule": "required","type": "CreateStream","name": "createStream","id": 2}]},{"name": "SetupStreamResponse","fields": [{"rule": "required","type": "string","name": "status","id": 1},{"rule": "optional","type": "CreateStreamResponse","name": "createStreamResponse","id": 2}]},{"name": "EndStream","fields": [{"rule": "required","type": "string","name": "streamId","id": 1},{"rule": "optional","type": "string","name": "reason","id": 2,"options": {"default": "ended"}}]},{"name": "EndStreamResponse","fields": [{"rule": "required","type": "string","name": "status","id": 1}]}]}';return b.prototype.getApiVersion=function(){return this._apiVersion},b.prototype.encode=function(a,b){if("string"!=typeof a)throw new Error("'type' must be a string");if("object"!=typeof b)throw new Error("'data' must be an object");var d=c.call(this,a);return d.encode(b)},b.prototype.decode=function(a,b){if("string"!=typeof a)throw new Error("'type' must be a string");var d=c.call(this,a);return d.decode(b)},b}),define("sdk/PhenixPCast",["sdk/PhenixProtocol","phenix-rtc"],function(a,b){"use strict";function c(a){this._uri=a||"wss://pcast-europe-west.phenixp2p.com/ws",this._status="offline"}function d(){var a=this;this._connected=!0,this._stopped||this._protocol.authenticate(this._authToken,function(b,c){a._authenticationCallback&&(c?(j("Failed to authenticate: "+JSON.stringify(c)),h.call(a,"offline"),a._authenticationCallback.call(a,a,"failed","")):(h.call(a,"online"),a._authenticationCallback.call(a,a,b.status,b.sessionId)))})}function e(){this._connected=!1,h.call(this,"offline")}function f(a){var b=this._mediaStreams[a.streamId];b&&"function"==typeof b.streamEnded&&b.streamEnded(a.reason),delete this._mediaStreams[a.streamId]}function g(a,c,d){function e(){function c(c){i("Created answer: "+c.sdp),f._protocol.setAnswerDescription(a,c.sdp,function(a,c){function d(){i("Set local description (answer)")}if(c)return j("Failed to set answer description: "+JSON.stringify(c)),o();var e=new b.RTCSessionDescription({type:"answer",sdp:a.sessionDescription.sdp});h.setLocalDescription(e,d,o)})}i("Set remote description (offer)"),h.createAnswer(c,o,m)}var f=this,g=!1,h=new b.RTCPeerConnection(k,l);f._peerConnections[a]=h;var n=function(c){if(!g){var e=c.stream;console.log("Got a remote stream");var k={stop:function(){h.close(),f._protocol.destroyStream(a,"",function(b,c){return c?void j("["+a+"] failed to destroy stream"):void i("["+a+"] destroyed stream")}),delete f._peerConnections[a]},setStreamEndedCallback:function(a){this.streamEnded=a},createRenderer:function(){return{start:function(a){return b.attachMediaStream(a,e)},stop:function(){}}}};f._mediaStreams[a]=k,d.call(f,k)}},o=function(){d.call(f,void 0,"failed"),delete f._peerConnections[a],h.close()};b.addEventListener(h,"addstream",n);var p=new b.RTCSessionDescription({type:"offer",sdp:c});h.setRemoteDescription(p,e,o),h.onicecandidate=function(b){var c=b.candidate;i(c?"["+a+"] ICE candidate (receiver): "+c.sdpMid+" "+c.sdpMLineIndex+" "+c.candidate:"["+a+"] ICE candidate discovery complete (receiver)")}}function h(a){if(this._status!==a)switch(this._status=a,a){case"connecting":break;case"offline":this._offlineCallback.call(this);break;case"online":this._onlineCallback.call(this)}}var i=function(){console.log.apply(console,arguments)}||function(){},j=function(){console.error.apply(console,arguments)}||i,k={iceServers:[{url:"stun:stun.l.google.com:19302"},{url:"stun:stun1.l.google.com:19302"},{url:"stun:stun2.l.google.com:19302"},{url:"stun:stun3.l.google.com:19302"},{url:"stun:stun4.l.google.com:19302"}]},l={optional:[{DtlsSrtpKeyAgreement:!1},{RtpDataChannels:!1}]},m={mandatory:{OfferToReceiveVideo:!0,OfferToReceiveAudio:!0}};return c.prototype.getUri=function(){return this._uri},c.prototype.getStatus=function(){return this._status},c.prototype.start=function(b,c,g,h){if("string"!=typeof b)throw new Error('"authToken" must be a string');if("function"!=typeof c)throw new Error('"authenticationCallback" must be a function');if("function"!=typeof g)throw new Error('"authenticationCallback" must be a function');if("function"!=typeof h)throw new Error('"authenticationCallback" must be a function');if(this._started)throw new Error('"Already started"');this._stopped=!1,this._started=!0,this._authToken=b,this._authenticationCallback=c,this._onlineCallback=g,this._offlineCallback=h,this._status="connecting",this._protocol=new a(this._uri),this._protocol.on("connected",d.bind(this)),this._protocol.on("disconnected",e.bind(this)),this._protocol.on("streamEnded",f.bind(this)),this._peerConnections={},this._mediaStreams={}},c.prototype.stop=function(){if(this._started){this._stopped=!0,this._started=!1,this._protocol.disconnect(),delete this._authenticationCallback;for(var a in this._peerConnections)this._peerConnections.hasOwnProperty(a)&&this._peerConnections[a].close();this._peerConnections={}}},c.prototype.subscribe=function(a,b){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var c=this;this._protocol.createDownloader(a,function(a,d){if(d)j("Failed to create downloader: "+JSON.stringify(d)),b.call(c,c,"failed");else{var e=a.createStreamResponse.streamId,f=a.createStreamResponse.createOfferDescriptionResponse.sessionDescription.sdp;g.call(c,e,f,function(a,d){d?b.call(c,c,"failed",null):b.call(c,c,"ok",a)})}})},c.prototype.toString=function(){return"PhenixPCast["+this._sessionId+","+this._protocol.toString()+"]"},c}),define("sdk/PhenixProtocol",["sdk/MQProtocol","ByteBuffer","phenix-rtc"],function(a,b,c){"use strict";function d(b){this._uri=b,this._mqProtocol=new a,l("Connecting to "+b),this._webSocket=new WebSocket(b),this._webSocket.onopen=h.bind(this),this._webSocket.onclose=i.bind(this),this._webSocket.onmessage=j.bind(this),this._webSocket.onerror=k.bind(this),this._nextRequestId=0,this._events={},this._requests={}}function e(a,b,c){var d=(this._nextRequestId++).toString(),e={requestId:d,type:a,payload:this._mqProtocol.encode(a,b)};return this._requests[d]=c,this._webSocket.send(this._mqProtocol.encode("mq.Request",e).toString("base64"))}function f(a){var b=this._events[a];return b||(this._events[a]=b=[]),b}function g(a,b){var c=this._events[a];if(c)for(var d=0;d<c.length;d++)c[d].apply(this,b)}function h(a){l("Connected"),g.call(this,"connected")}function i(a){l("Disconnected ["+a.code+"]: "+a.reason),g.call(this,"disconnected",[a.code,a.reason])}function j(a){l(">> "+a.data);var c=this._mqProtocol.decode("mq.Response",b.wrap(a.data,"base64"));l(">> "+c.type);var d=this._mqProtocol.decode(c.type,c.payload);"pcast.AuthenticateResponse"===c.type?this._sessionId=d.sessionId:"pcast.StreamEnded"===c.type&&g.call(this,"streamEnded",[d]);var e=this._requests[c.requestId];e&&(delete this._requests[c.requestId],"mq.Error"===c.type||"ok"!==d.status?e(void 0,d):e(d))}function k(a){m("Error: "+a.data)}var l=function(){console.log.apply(console,arguments)}||function(){},m=function(){console.error.apply(console,arguments)}||l;return d.prototype.on=function(a,b){if("string"!=typeof a)throw new Error('"eventName" must be a string');if("function"!=typeof b)throw new Error('"handler" must be a function');var c=f.call(this,a);c.push(b)},d.prototype.authenticate=function(a,b){if("string"!=typeof a)throw new Error('"authToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var d={apiVersion:this._mqProtocol.getApiVersion(),clientVersion:"2015-10-15T15:54:00T",deviceId:"",platform:c.browser,platformVersion:c.browserVersion.toString(),authenticationToken:a};return this._sessionId&&(auth.sessionId=this._sessionId),e.call(this,"pcast.Authenticate",d,b)},d.prototype.disconnect=function(){return delete this._sessionId,this._webSocket.close(1e3,"byebye")},d.prototype.createDownloader=function(a,b){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var c={streamToken:a,createStream:{sessionId:this._sessionId,createOfferDescription:{streamId:"",options:["download","SRTP"],apiVersion:this._mqProtocol.getApiVersion()}}};return e.call(this,"pcast.SetupStream",c,b)},d.prototype.setAnswerDescription=function(a,b,c){if("string"!=typeof a)throw new Error('"streamId" must be a string');if("string"!=typeof b)throw new Error('"sdp" must be a string');if("function"!=typeof c)throw new Error('"callback" must be a function');var d={streamId:a,sessionDescription:{type:"Answer",sdp:b},apiVersion:this._mqProtocol.getApiVersion()};return e.call(this,"pcast.SetRemoteDescription",d,c)},d.prototype.destroyStream=function(a,b,c){if("string"!=typeof a)throw new Error('"streamId" must be a string');if("string"!=typeof b)throw new Error('"reason" must be a string');if("function"!=typeof c)throw new Error('"callback" must be a function');var d={streamId:a,reason:b};return e.call(this,"pcast.DestroyStream",d,c)},d.prototype.toString=function(){return"PhenixProtocol["+this._uri+","+this._webSocket.readyState+"]"},d}),define("phenix-web-sdk",["sdk/PhenixPCast"],function(a){return window.PhenixPCast=a,{PCast:a}});