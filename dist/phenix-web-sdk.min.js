/**
 * Copyright 2017 PhenixP2P Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
!function(a,b){if("object"==typeof exports&&"object"==typeof module)module.exports=b(require("phenix-rtc"),require("protobuf"),require("ByteBuffer"));else if("function"==typeof define&&define.amd)define(["phenix-rtc","protobuf","ByteBuffer"],b);else{var c="object"==typeof exports?b(require("phenix-rtc"),require("protobuf"),require("ByteBuffer")):b(a["phenix-rtc"],a.protobuf,a.ByteBuffer);for(var d in c)("object"==typeof exports?exports:a)[d]=c[d]}}(this,function(a,b,c){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={exports:{},id:d,loaded:!1};return a[d].call(e.exports,e,e.exports,b),e.loaded=!0,e.exports}var c={};return b.m=a,b.c=c,b.p="",b(0)}([function(a,b,c){var d,e;d=[c(1),c(2),c(5)],e=function(a,b,c){return window.PhenixPCast=b,{PCast:b,Logger:c,RTC:a}}.apply(b,d),!(void 0!==e&&(a.exports=e))},function(b,c){b.exports=a},function(a,b,c){var d,e;d=[c(3),c(8),c(12),c(13),c(11),c(5),c(1)],e=function(a,b,c,d,e,f,g){"use strict";function h(a){a=a||{},this._logger=a.logger||new f,this._baseUri=a.uri||b.DefaultPCastUri,this._deviceId=a.deviceId||"",this._version=P,this._endPoint=new b(this._version,this._baseUri,this._logger),this._screenSharingExtensionId=a.screenSharingExtensionId||Q,this._screenSharingAddOn=a.screenSharingAddOn||R,this._screenSharingEnabled=!1,this._shaka=a.shaka||window.shaka,this._videojs=a.videojs||window.videojs,this._status="offline","Chrome"===g.browser&&this._screenSharingExtensionId&&k.call(this),g.addEventListener(window,"unload",function(a){return function(){a.stop()}}(this))}function i(a){var b=this;if("Chrome"===g.browser&&b._screenSharingExtensionId)try{chrome.runtime.sendMessage(b._screenSharingExtensionId,{type:"version"},function(c){c&&"ok"===c.status?(b._logger.info("Screen sharing enabled using version [%s]",c.version),a(!0)):(b._logger.info("Screen sharing NOT available"),a(!1))})}catch(c){c.message&&b._logger.warn(c.message,c),a(!1)}else a("Firefox"===g.browser&&"object"==typeof window.PCastScreenSharing?!0:!1)}function j(){return"https://chrome.google.com/webstore/detail/"+this._screenSharingExtensionId}function k(){for(var a=j.call(this),b=document.getElementsByTagName("link"),c=0;c<b.length;c++)if(b[c].href===a)return;this._logger.debug("Adding Chrome Web Store link [%s]",a);var d=document.createElement("link");d.rel="chrome-webstore-item",d.href=a,document.getElementsByTagName("head")[0].appendChild(d)}function l(a){var b=this,c=j.call(this);try{chrome.webstore.install(c,function(){return a("ok")},function(c){if(c){if(c.match(/cancelled/gi))return b._logger.info("User cancelled screen sharing"),a("cancelled",new Error(c));b._logger.warn(c)}return a("failed",new Error(c||"failed"))})}catch(d){d.message&&b._logger.warn(d.message),a("failed",d)}}function m(a){try{var b,c={"PCast Screen Sharing":{URL:this._screenSharingAddOn.url,IconURL:this._screenSharingAddOn.iconUrl,Hash:this._screenSharingAddOn.hash,toString:function(){return this.URL}}},d=T,e=function(){b&&clearInterval(b),a("ok")},f=function(){b&&clearInterval(b),a("failed",new Error("failed"))};b=setInterval(function(){return"object"==typeof window.PCastScreenSharing?e():d--<0?f():void 0},S),InstallTrigger.install(c,function(a,b){0===b?e():f()})}catch(g){g.message&&this._logger.warn(g.message),a("failed",g)}}function n(a,b){var c=this;switch(g.browser){case"Chrome":try{chrome.runtime.sendMessage(c._screenSharingExtensionId,{type:"get-desktop-media"},function(c){if("ok"!==c.status)return b(c.status,void 0,new Error(c.status));var d={video:{}};"object"==typeof a&&"object"==typeof a.screen&&(d.video=a.screen),"object"!=typeof d.video.mandatory&&(d.video.mandatory={}),d.video.mandatory.chromeMediaSource="desktop",d.video.mandatory.chromeMediaSourceId=c.streamId,b("ok",d,void 0)})}catch(d){d.message&&c._logger.warn(d.message),b("failed",void 0,d)}break;case"Firefox":var e={video:{}};"object"==typeof a&&"object"==typeof a.screen&&(e.video=a.screen),e.video.mediaSource="window",b("ok",e,void 0);break;default:b("not-supported",void 0,new Error("not-supported"))}}function o(a,b){var c=this;if(a.screen)if(c._screenSharingEnabled)n.call(c,a,b);else{var d=function(d){return"cancelled"===d?b(d,"cancelled"):"ok"!==d?b(d,void 0,new Error("screen-sharing-installation-failed")):void i.call(c,function(e){return c._screenSharingEnabled=e,c._screenSharingEnabled?void n.call(c,a,b):b(d,void 0,new Error("screen-sharing-installation-failed"))})};switch(g.browser){case"Chrome":l.call(c,d);break;case"Firefox":m.call(c,d);break;default:b("not-supported",void 0,new Error("not-supported"))}}else{var e={audio:a.audio||!1,video:a.video||!1};b("ok",e,void 0)}}function p(a,b){var c=this,d=function(a,d){c._gumStreams.push(d),b(c,a,d)},e=function(a,d,e){b(c,a,d,e)},f=a.screen,g=a.video||a.audio;return f&&g?q.call(c,{audio:a.audio,video:a.video},function(b,f){return q.call(c,{screen:a.screen},function(a,b){H(f,b.getTracks()),d(a,f)},function(a,b,c){I(f),e(a,b,c)})},e):q.call(c,a,d,e)}function q(a,b,c){var d=function(){c("cancelled",null)},e=function(a){c(U(a),void 0,a)},f=function(a){b("ok",a)};return o.call(this,a,function(a,b,c){if("cancelled"===a)return d();if("ok"!==a)return e(c);try{g.getUserMedia(b,f,e)}catch(h){e(h)}})}function r(){var a=this;this._connected=!0,a._stopped||a._protocol.authenticate(a._authToken,function(b,c){a._authenticationCallback&&(c?(a._logger.warn("Failed to authenticate",c),G.call(a,"offline"),a._authenticationCallback.call(a,a,"unauthorized",""),a.stop("unauthorized")):(G.call(a,"online"),a._authenticationCallback.call(a,a,b.status,b.sessionId)))})}function s(){this._connected=!1,G.call(this,"offline")}function t(a){switch(a){case"":case"none":case"ended":return"ended";case"server-error":case"not-ready":case"error":return"failed";case"censored":return"censored";case"maintenance":return"maintenance";case"capacity":return"capacity";case"app-background":return"app-background";default:return"custom"}}function u(a){var b=a.streamId,c=a.reason;return w.call(this,b,c)}function v(a){var b=a.streamId,c=a.status,d=a.reason,e=this._mediaStreams[b];e&&e.dataQualityChangedCallback(c,d);var f=this._publishers[b];f&&"function"==typeof f.dataQualityChangedCallback&&f.dataQualityChangedCallback(f,c,d)}function w(a,b){this._logger.info("[%s] Stream ended with reason [%s]",a,b);var c=this._mediaStreams[a];c&&c.streamEndedCallback(t(b),b),delete this._mediaStreams[a];var d=this._publishers[a];d&&"function"==typeof d.publisherEndedCallback&&d.publisherEndedCallback(d,t(b),b),delete this._publishers[a];var e=this._peerConnections[a];e&&L.call(this,a,e,"ended"),delete this._peerConnections[a]}function x(a,b,e,f,h){var i=this,j=function(j){function k(){for(var a=m.getTracks(),b=0;b<a.length;b++){var c=a[b];if(!J(c))return!1}return!0}function l(c){b.stopped||(i._logger.info("[%s] stop media stream",a),L.call(i,a,e,"stop"),i._protocol.destroyStream(a,c||"",function(b,c){return c?void i._logger.error("[%s] failed to destroy stream",a):void i._logger.info("[%s] destroyed stream",a)}),b.stopped=!0)}if(!b.failed){var m=j.stream;if(!m)return b.failed=!0,i._logger.warn("[%s] No remote stream",a),f.call(i,void 0,"failed");i._logger.info("[%s] Got remote stream",a);var n=function p(f){var j={children:[],renderer:null,isStopped:!1,isStreamEnded:!1,mediaStream:{createRenderer:function(){var a=null,b=new d(i._logger);return{start:function(c){return a=g.attachMediaStream(c,f),h.receiveAudio===!1&&(c.muted=!0),j.renderer=this,b.start(this,a),a},stop:function(){b.stop(),a&&a.pause(),a=null,j.renderer=null},getStats:function(){return a?{width:a.videoWidth||a.width,height:a.videoHeight||a.height,currentTime:a.currentTime,networkState:a.networkState}:{width:0,height:0,currentTime:0,networkState:N.NETWORK_NO_SOURCE}},setDataQualityChangedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.dataQualityChangedCallback=a},setVideoDisplayDimensionsChangedCallback:function(a,c){b.setVideoDisplayDimensionsChangedCallback(a,c)}}},setStreamEndedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamEndedCallback=a},setStreamErrorCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamErrorCallback=a},stop:function(a){j.isStopped||(I(f),k()&&l(a),j.isStopped=!0)},monitor:function n(b,d){if("object"!=typeof b)throw new Error('"options" must be an object');if("function"!=typeof d)throw new Error('"callback" must be a function');var n=new c(a,e,i._logger);b.direction="inbound",n.start(b,function(){return j.mediaStream.isActive()},function(b){return i._logger.warn("[%s] Media stream triggered monitor condition for [%s]",a,b),d(j.mediaStream,"client-side-failure",b)})},getStream:function(){return f},isActive:function(){var c=b.stopped,d="object"!=typeof i._mediaStreams[a],e=j.isStopped;return!c&&!d&&!e},getStreamId:function(){return a},select:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');if("function"!=typeof window.MediaStream)throw new Error("MediaStream not supported in current browser");for(var b=m.getTracks(),c=new window.MediaStream,d=0;d<b.length;d++)a(b[d],d)&&c.addTrack(b[d]);if(0===c.getTracks().length)return i._logger.warn("No tracks selected");var e=p(c);return j.children.push(e),e.mediaStream}},streamErrorCallback:function(a,b){for(var c=0;c<j.children.length;c++)j.children[c].streamErrorCallback(a,b);var d=j.mediaStream;"function"==typeof d.streamErrorCallback&&d.streamErrorCallback(d,a,b)},streamEndedCallback:function(a,b){for(var c=0;c<j.children.length;c++)j.children[c].streamEndedCallback(a,b);if(!j.isStreamEnded){var d=j.mediaStream;j.isStreamEnded=!0,"function"==typeof d.streamEndedCallback&&d.streamEndedCallback(d,a,b),d.stop(),j.renderer&&j.renderer.stop()}},dataQualityChangedCallback:function(a,b){for(var c=0;c<j.children.length;c++)j.children[c].dataQualityChangedCallback(a,b);var d=j.renderer;d&&"function"==typeof d.dataQualityChangedCallback&&d.dataQualityChangedCallback(d,a,b)}};return j},o=n(m);i._mediaStreams[a]=o,f.call(i,o.mediaStream)}};g.addEventListener(e,"addstream",j)}function y(a,b,c){var d=this,e=function(b){var e=b.candidate;e?d._logger.debug("[%s] ICE candidate: [%s] [%s] [%s]",a,e.sdpMid,e.sdpMLineIndex,e.candidate):d._logger.info("[%s] ICE candidate discovery complete",a),c&&c(e)};g.addEventListener(b,"icecandidate",e)}function z(a,b){var c=this,d=function(a){c._logger.info("[%s] Negotiation needed")},e=function(d){c._logger.info("[%s] ICE connection state changed [%s]",a,b.iceConnectionState)},f=function(d){c._logger.info("[%s] ICE gathering state changed [%s]",a,b.iceGatheringState)},h=function(d){c._logger.info("[%s] Signaling state changed [%s]",a,b.signalingState)},i=function(d){c._logger.info("[%s] Connection state changed [%s]",a,b.connectionState)};g.addEventListener(b,"negotiationneeded",d),g.addEventListener(b,"iceconnectionstatechange",e),g.addEventListener(b,"icegatheringstatechange ",f),g.addEventListener(b,"signalingstatechange",h),g.addEventListener(b,"connectionstatechange",i)}function A(a,b,c){var d=this,e={stopped:!1},f={getStreamId:function(){return a},isActive:function(){return!e.stopped},hasEnded:function(){return e.stopped},stop:function(b){e.stopped||(d._protocol.destroyStream(a,b||"",function(b,c){return c?void d._logger.error("[%s] failed to destroy stream",a):void d._logger.info("[%s] destroyed stream",a)}),e.stopped=!0)},setPublisherEndedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.publisherEndedCallback=a},setDataQualityChangedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.dataQualityChangedCallback=a},getOptions:function(){return c}};d._publishers[a]=f,b(f)}function B(a,b,d,e,f,h){function i(){function a(a){j._logger.info("Created answer [%s]",a.sdp),j._protocol.setAnswerDescription(b,a.sdp,function(a,f){function i(){var a=/(b=AS:([0-9]*)[\n\r]*)/gi,f=/(mid:video)([\n\r]*)/gi;j._logger.info("Set local description (answer)");var i=0,l=a.exec(d);l&&l.length>=3&&(i=1e3*l[2]);var m={getStreamId:function(){return b},isActive:function(){return!k.stopped},hasEnded:function(){switch(n.iceConnectionState){case"new":case"checking":case"connected":case"completed":return!1;case"disconnected":case"failed":case"closed":return!0;default:return!0}},stop:function(a){k.stopped||(L.call(j,b,n,"closed"),j._protocol.destroyStream(b,a||"",function(a,c){return c?void j._logger.error("[%s] failed to destroy stream",b):void j._logger.info("[%s] destroyed stream",b)}),k.stopped=!0)},setPublisherEndedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.publisherEndedCallback=a},setDataQualityChangedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.dataQualityChangedCallback=a},limitBandwidth:function(b){if("number"!=typeof b)throw new Error('"bandwidthLimit" must be a number');var c=i?Math.min(b,i):b,d=n.remoteDescription;j._logger.info("Changing bandwidth limit to [%s]",c);var e=d.sdp.replace(a,"");e=e.replace(f,function(a,b,d,e,f){return[b,d,"b=AS:",Math.ceil(c/1e3),d].join("")});var h=new g.RTCSessionDescription({type:d.type,sdp:e});return n.setRemoteDescription(h),{dispose:function(){n.setRemoteDescription(d)}}},monitor:function p(a,d){if("object"!=typeof a)throw new Error('"options" must be an object');if("function"!=typeof d)throw new Error('"callback" must be a function');var p=new c(b,n,j._logger);a.direction="outbound",p.start(a,function(){return j._publishers[b]===m&&!k.stopped},function(a){return j._logger.warn("[%s] Publisher triggered monitor condition for [%s]",b,a),d(m,"client-side-failure",a)})},setRemoteMediaStreamCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.remoteMediaStreamCallback=a,o&&a(m,o)},getOptions:function(){return h}};j._publishers[b]=m,e.call(j,m)}if(f)return j._logger.warn("Failed to set answer description",f),q();K(a.options,"ice-candidates")&&(p=function(a){var c=[],d=[];a?c.push(a):d.push("completed"),j._protocol.addIceCandidates(b,c,d,function(a,b){return b?void j._logger.warn("Failed to add ICE candidate",b):void(K(a.options,"cancel")&&(p=null))})});var l=new g.RTCSessionDescription({type:"answer",sdp:a.sessionDescription.sdp});n.setLocalDescription(l,i,q)})}j._logger.info("Set remote description (offer)");var i={mandatory:{}};"Chrome"===g.browser?(i.mandatory.OfferToReceiveVideo=f.receiveVideo===!0,i.mandatory.OfferToReceiveAudio=f.receiveAudio===!0):(i.mandatory.offerToReceiveVideo=f.receiveVideo===!0,i.mandatory.offerToReceiveAudio=f.receiveAudio===!0),n.createAnswer(a,q,i)}var j=this,k={failed:!1,stopped:!1},l=d.match(/a=crypto:/i),m=d.match(/m=application /i),n=new g.RTCPeerConnection(O,{optional:[{DtlsSrtpKeyAgreement:!l},{RtpDataChannels:m}]}),o=null,p=null;j._peerConnections[b]=n,n.addStream(a);var q=function(){k.failed||(k.failed=!0,k.stopped=!0,delete j._peerConnections[b],L.call(j,b,n,"failure"),e.call(j,void 0,"failed"))};x.call(j,b,k,n,function(a){var c=j._publishers[b];o=a,c&&c.remoteMediaStreamCallback&&c.remoteMediaStreamCallback(c,a)},f),y.call(j,b,n,function(a){p&&p(a)}),z.call(j,b,n);var r=new g.RTCSessionDescription({type:"offer",sdp:d});n.setRemoteDescription(r,i,q)}function C(a,b,c,d){function e(){function b(b){f._logger.info("Created answer [%s]",b.sdp),f._protocol.setAnswerDescription(a,b.sdp,function(b,c){function d(){f._logger.debug("Set local description (answer)")}if(c)return f._logger.warn("Failed to set answer description",c),m();K(b.options,"ice-candidates")&&(l=function(b){var c=[],d=[];b?c.push(b):d.push("completed"),f._protocol.addIceCandidates(a,b,d,function(a,b){return b?void f._logger.warn("Failed to add ICE candidate",b):void(K(a.options,"cancel")&&(l=null))})});var e=new g.RTCSessionDescription({type:"answer",sdp:b.sessionDescription.sdp});k.setLocalDescription(e,d,m)})}f._logger.debug("Set remote description (offer)");var c={mandatory:{}};"Chrome"===g.browser?(c.mandatory.OfferToReceiveVideo=d.receiveVideo!==!1,c.mandatory.OfferToReceiveAudio=d.receiveAudio!==!1):(c.mandatory.offerToReceiveVideo=d.receiveVideo!==!1,c.mandatory.offerToReceiveAudio=d.receiveAudio!==!1),k.createAnswer(b,m,c)}var f=this,h={failed:!1,stopped:!1},i=b.match(/a=crypto:/i),j=b.match(/m=application /i),k=new g.RTCPeerConnection(O,{optional:[{DtlsSrtpKeyAgreement:!i},{RtpDataChannels:j}]}),l=null;f._peerConnections[a]=k;var m=function(){h.failed||(h.failed=!0,h.stopped=!0,delete f._peerConnections[a],L.call(f,a,k,"failure"),c.call(f,void 0,"failed"))};x.call(f,a,h,k,c,d),y.call(f,a,k,function(a){l&&l(a)}),z.call(f,a,k);var n=new g.RTCSessionDescription({type:"offer",sdp:b});k.setRemoteDescription(n,e,m)}function D(a,b,c,d){var e=this,f=b.match("a=x-playlist:([^\n]*[.]mpd)"),g=b.match("a=x-playlist:([^\n]*[.]m3u8)");return f&&2===f.length&&e._shaka&&e._shaka.Player.isBrowserSupported()?E.call(e,a,f[1],c,d):g&&2===g.length&&"maybe"===document.createElement("video").canPlayType("application/vnd.apple.mpegURL")?F.call(e,a,g[1],c,d):(e._logger.warn("[%s] Offer does not contain a supported manifest",a,b),c.call(e,void 0,"failed"))}function E(a,b,c,e){var f=this;if(!f._shaka)return f._logger.warn("[%s] Shaka player not available",a),c.call(f,void 0,"live-player-missing");if(!f._shaka.Player.isBrowserSupported())return f._logger.warn("[%s] Shaka does not support this browser",a),c.call(f,void 0,"browser-unsupported");var g=f._shaka,h=encodeURI(b).replace(/[#]/g,"%23"),i=function(b){var c=j;c.streamErrorCallback?(f._logger.debug("[%s] DASH live stream error event [%s]",a,b.detail),c.streamErrorCallback(c,"shaka",b.detail)):f._logger.error("[%s] DASH live stream error event [%s]",a,b.detail)},j={renderer:null,isStreamEnded:!1,isStopped:!1,mediaStream:{createRenderer:function(){var b=null,c=new d(f._logger);return{start:function(d){b=new g.Player(d),e.receiveAudio===!1&&(d.muted=!0),j.renderer=this,b.addEventListener("error",i);b.load(h).then(function(){f._logger.info("[%s] DASH live stream has been loaded",a)})["catch"](function(b){f._logger.error("[%s] Error while loading DASH live stream [%s]",a,b.code,b),j.streamErrorCallback("shaka",b)});return c.start(this,d),d},stop:function(){if(c.stop(),b){var d=function(){var a="";j.streamEndedCallback(t(a),a),b=null};b.destroy().then(function(){f._logger.info("[%s] DASH live stream has been destroyed",a)}).then(function(){d()})["catch"](function(b){f._logger.error("[%s] Error while destroying DASH live stream [%s]",a,b.code,b),d(),j.streamErrorCallback("shaka",b)})}j.renderer=null},getStats:function(){if(!b)return{width:0,height:0,currentTime:0,networkState:N.NETWORK_NO_SOURCE};var a=b.getStats();return a.currentTime=a.playTime+a.bufferingTime,a.estimatedBandwidth>0?a.networkState=N.NETWORK_LOADING:a.playTime>0?a.networkState=N.NETWORK_IDLE:a.video?a.networkState=N.NETWORK_EMPTY:a.networkState=N.NETWORK_NO_SOURCE,a},setDataQualityChangedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.dataQualityChangedCallback=a},getPlayer:function(){return b},isActive:function(){return!j.isStopped},getStreamId:function(){return a},setVideoDisplayDimensionsChangedCallback:function(a,b){c.setVideoDisplayDimensionsChangedCallback(a,b)}}},select:function(b){return f._logger.warn("[%s] selection of tracks not supported for shaka live streams",a),this},setStreamEndedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamEndedCallback=a},setStreamErrorCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamErrorCallback=a},stop:function(b){j.isStopped||(f._logger.info("[%s] stop media stream",a),f._protocol.destroyStream(a,b||"",function(b,c){return c?void f._logger.error("[%s] failed to destroy stream",a):void f._logger.info("[%s] destroyed stream",a)}),j.isStopped=!0)},monitor:function(a,b){if("object"!=typeof a)throw new Error('"options" must be an object');if("function"!=typeof b)throw new Error('"callback" must be a function')}},streamErrorCallback:function(a,b){var c=j.mediaStream;"function"==typeof c.streamErrorCallback&&c.streamErrorCallback(c,a,b)},streamEndedCallback:function(a,b){if(!j.isStreamEnded){var c=j.mediaStream;j.isStreamEnded=!0,"function"==typeof c.streamEndedCallback&&c.streamEndedCallback(c,a,b),c.stop(),j.renderer&&j.renderer.stop()}},dataQualityChangedCallback:function(a,b){var c=j.renderer;c&&"function"==typeof c.dataQualityChangedCallback&&c.dataQualityChangedCallback(c,a,b)}};f._mediaStreams[a]=j,c.call(f,j.mediaStream)}function F(a,b,c,e){var f=this,g=encodeURI(b).replace(/[#]/g,"%23"),h=function(b){var c=i.mediaStream;c.streamErrorCallback?(f._logger.debug("[%s] HLS live stream error event [%s]",a,b.detail),c.streamErrorCallback(c,"hls",b.detail)):f._logger.error("[%s] HLS live stream error event [%s]",a,b.detail)},i={renderer:null,isStreamEnded:!1,isStopped:!1,mediaStream:{createRenderer:function(){var b=null,c=new d(f._logger);return{start:function(d){try{return d.src=g,e.receiveAudio===!1&&(d.muted=!0),i.renderer=this,d.addEventListener("error",h),d.play(),b=d,c.start(this,b),d}catch(j){f._logger.error("[%s] Error while loading HLS live stream [%s]",a,j.code,j),i.streamErrorCallback("hls",j)}},stop:function(){if(c.stop(),b){var d=function(){b=null;var a="";i.streamEndedCallback(t(a),a)};try{b.pause(),f._logger.info("[%s] HLS live stream has been destroyed",a),d()}catch(e){f._logger.error("[%s] Error while destroying HLS live stream [%s]",a,e.code,e),d(),i.streamErrorCallback("hls",e)}}i.renderer=null},getStats:function(){return b?{width:b.videoWidth||b.width,height:b.videoHeight||b.height,currentTime:b.currentTime,networkState:b.networkState}:{width:0,height:0,currentTime:0,networkState:N.NETWORK_NO_SOURCE}},setDataQualityChangedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.dataQualityChangedCallback=a},setVideoDisplayDimensionsChangedCallback:function(a,b){c.setVideoDisplayDimensionsChangedCallback(a,b)}}},select:function(b){return f._logger.warn("[%s] selection of tracks not supported for HLS live streams",a),this},setStreamEndedCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamEndedCallback=a},setStreamErrorCallback:function(a){if("function"!=typeof a)throw new Error('"callback" must be a function');this.streamErrorCallback=a},stop:function(b){i.isStopped||(f._logger.info("[%s] stop media stream",a),f._protocol.destroyStream(a,b||"",function(b,c){return c?void f._logger.error("[%s] failed to destroy stream",a):void f._logger.info("[%s] destroyed stream",a)}),i.isStopped=!0)},monitor:function(a,b){if("object"!=typeof a)throw new Error('"options" must be an object');if("function"!=typeof b)throw new Error('"callback" must be a function')},isActive:function(){return!i.isStopped},getStreamId:function(){return a}},streamErrorCallback:function(a,b){var c=i.mediaStream;"function"==typeof c.streamErrorCallback&&c.streamErrorCallback(c,a,b)},streamEndedCallback:function(a,b){if(!i.isStreamEnded){var c=i.mediaStream;i.isStreamEnded=!0,"function"==typeof c.streamEndedCallback&&c.streamEndedCallback(c,a,b),c.stop(),i.renderer&&i.renderer.stop()}},dataQualityChangedCallback:function(a,b){var c=i.renderer;c&&"function"==typeof c.dataQualityChangedCallback&&c.dataQualityChangedCallback(c,a,b)}};f._mediaStreams[a]=i,c.call(f,i.mediaStream)}function G(a){if(this._status!==a)switch(this._status=a,a){case"connecting":break;case"offline":this._offlineCallback.call(this);break;case"online":this._onlineCallback.call(this)}}function H(a,b){if("object"==typeof a&&"object"==typeof b&&b.constructor===Array)for(var c=0;c<b.length;c++)a.addTrack(b[c])}function I(a){if(a&&"function"==typeof a.getTracks)for(var b=a.getTracks(),c=0;c<b.length;c++){var d=b[c];d.stop()}}function J(a){if("object"!=typeof a)throw new Error("Invalid track.");return"ended"===a.readyState}function K(a,b){if(!a)return!1;if("function"==typeof a.indexOf)return a.indexOf(b)!==-1;for(var c=0;c<a.length;c++)if(a[c]===b)return!0;return!1}function L(a,b,c){"closed"===b.signalingState||b.__closing||(this._logger.debug("[%s] close peer connection [%s]",a,c),b.close(),b.__closing=!0)}var M=function(a){return"freeze"in Object?Object.freeze(a):a},N=M({NETWORK_EMPTY:0,NETWORK_IDLE:1,NETWORK_LOADING:2,NETWORK_NO_SOURCE:3}),O=M({iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}]}),P="2017-03-30T21:46:21Z",Q="icngjadgidcmifnehjcielbmiapkhjpn",R=M({url:"https://addons.mozilla.org/firefox/downloads/file/474686/pcast_screen_sharing-1.0.3-an+fx.xpi",iconUrl:"https://phenixp2p.com/public/images/phenix-logo-unicolor-64x64.png",hash:"sha256:4972e9718ea7f7c896abc12d1a9e664d5f3efe498539b082ab7694f9d7af4f3b"}),S=100,T=450;h.prototype.getBaseUri=function(){return this._endPoint.getBaseUri()},h.prototype.getStatus=function(){return this._status},h.prototype.start=function(b,c,d,e){if("string"!=typeof b)throw new Error('"authToken" must be a string');if("function"!=typeof c)throw new Error('"authenticationCallback" must be a function');if("function"!=typeof d)throw new Error('"onlineCallback" must be a function');if("function"!=typeof e)throw new Error('"offlineCallback" must be a function');if(this._started)throw new Error('"Already started"');this._stopped=!1,this._started=!0,this._authToken=b,this._authenticationCallback=c,this._onlineCallback=d,this._offlineCallback=e,this._status="connecting",this._peerConnections={},this._mediaStreams={},this._publishers={},this._gumStreams=[];var f=this;i.call(f,function(b){f._screenSharingEnabled=b,f._endPoint.resolveUri(function(b,c){if(b){switch(f._logger.error("Failed to connect to [%s]",f._baseUri,b),G.call(f,"offline"),b.code){case 0:f._authenticationCallback.call(f,f,"network-unavailable","");break;case 503:f._authenticationCallback.call(f,f,"capacity","");break;default:f._authenticationCallback.call(f,f,"failed","")}return f._stopped=!0,void(f._started=!1)}f._logger.info("Discovered end point [%s]",c),f._protocol=new a(c,f._deviceId,f._version,f._logger),f._protocol.on("connected",r.bind(f)),f._protocol.on("disconnected",s.bind(f)),f._protocol.on("streamEnded",u.bind(f)),f._protocol.on("dataQuality",v.bind(f))})})},h.prototype.stop=function(){if(this._started){this._stopped=!0,this._started=!1,delete this._authenticationCallback;try{var a="";for(var b in this._mediaStreams)this._mediaStreams.hasOwnProperty(b)&&w.call(this,b,a);for(var b in this._publishers)if(this._publishers.hasOwnProperty(b)){var c=this._publishers[b];w.call(this,b,a),K(c.getOptions(),"detached")||c.stop(a)}for(var b in this._peerConnections)this._peerConnections.hasOwnProperty(b)&&w.call(this,b,a);for(var d=0;d<this._gumStreams.length;d++)for(var e=this._gumStreams[d].getTracks(),f=0;f<e.length;f++)e[f].stop()}finally{this._protocol&&this._protocol.disconnect()}}},h.prototype.getUserMedia=function(a,b){if("object"!=typeof a)throw new Error('"options" must be an object');if("function"!=typeof b)throw new Error('"callback" must be a function');return p.call(this,a,b)},h.prototype.publish=function(a,b,c,d,e){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("object"!=typeof b&&"string"!=typeof b)throw new Error('"streamToPublish" must be an object or URI');if("function"!=typeof c)throw new Error('"callback" must be a function');if(d=d||[],!Array.isArray(d))throw new Error('"tags" must be an array');if(e=e||{},"object"!=typeof e)throw new Error('"options" must be an object');var f=this,g="upload",h={negotiate:!0,connectOptions:e.connectOptions};"string"==typeof b?(h.negotiate=!1,h.connectUri=b):h.connectUri=e.connectUri,this._protocol.setupStream(g,a,h,function(a,d){if(!d){var g=a.createStreamResponse.streamId;if(h.negotiate===!0){var i=a.createStreamResponse.createOfferDescriptionResponse.sessionDescription.sdp;return B.call(f,b,g,i,function(a,b){b?c.call(f,f,"failed",null):c.call(f,f,"ok",a)},e,a.createStreamResponse.options)}return A.call(f,g,function(a,b){b?c.call(f,f,"failed",null):c.call(f,f,"ok",a)},a.createStreamResponse.options)}switch(f._logger.warn("Failed to create uploader",d),d.status){case"capacity":return c.call(f,f,d.status);default:return c.call(f,f,"failed")}})},h.prototype.subscribe=function(a,b,c){if("string"!=typeof a)throw new Error('"streamToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');if(c=c||{},"object"!=typeof c)throw new Error('"options" must be an object');var d=this,e="download",f={negotiate:c.negotiate!==!1,connectUri:c.connectUri,connectOptions:c.connectOptions};this._protocol.setupStream(e,a,f,function(a,e){if(!e){var f=a.createStreamResponse.streamId,g=a.createStreamResponse.createOfferDescriptionResponse.sessionDescription.sdp,h=C;return g.match(/a=x-playlist:/)&&(h=D),h.call(d,f,g,function(a,c){c?b.call(d,d,"failed",null):b.call(d,d,"ok",a)},c)}switch(d._logger.warn("Failed to create downloader",e),e.status){case"capacity":case"stream-ended":case"origin-stream-ended":case"streaming-not-available":return b.call(d,d,e.status);default:return b.call(d,d,"failed")}})},h.prototype.toString=function(){return"PhenixPCast["+this._sessionId+","+(this._protocol?this._protocol.toString():"uninitialized")+"]"};var U=function(a){var b;return b="unavailable"===a.code?"conflict":"permission-denied"===a.message?"permission-denied":"PermissionDeniedError"===a.name?"permission-denied":"InternalError"===a.name&&"Starting video failed"===a.message?"conflict":"SourceUnavailableError"===a.name?"conflict":"SecurityError"===a.name&&"The operation is insecure."===a.message?"permission-denied":"failed"};return h}.apply(b,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c(4),c(7),c(1)],e=function(a,b,c){"use strict";function d(b,c,d,e){if("string"!=typeof b)throw new Error('Must pass a valid "uri"');if("string"!=typeof c)throw new Error('Must pass a valid "deviceId"');if("string"!=typeof d)throw new Error('Must pass a valid "version"');if("object"!=typeof e)throw new Error('Must pass a valid "logger"');this._uri=b,this._deviceId=c,this._version=d,this._logger=e,this._mqProtocol=new a(this._logger),this._logger.info("Connecting to [%s]",b),this._webSocket=new WebSocket(b),this._webSocket.onopen=h.bind(this),this._webSocket.onclose=i.bind(this),this._webSocket.onmessage=j.bind(this),this._webSocket.onerror=k.bind(this),this._nextRequestId=0,this._events={},this._requests={}}function e(a,b,c){var d=(this._nextRequestId++).toString(),e={requestId:d,type:a,payload:this._mqProtocol.encode(a,b)};return this._requests[d]=c,this._webSocket.send(this._mqProtocol.encode("mq.Request",e).toString("base64"))}function f(a){var b=this._events[a];return b||(this._events[a]=b=[]),b}function g(a,b){var c=this._events[a];if(c)for(var d=0;d<c.length;d++)c[d].apply(this,b)}function h(a){this._logger.info("Connected"),g.call(this,"connected")}function i(a){this._logger.info("Disconnected [%s]: [%s]",a.code,a.reason),g.call(this,"disconnected",[a.code,a.reason])}function j(a){this._logger.debug(">> [%s]",a.data);var c=this._mqProtocol.decode("mq.Response",b.wrap(a.data,"base64"));this._logger.info(">> [%s]",c.type);var d=this._mqProtocol.decode(c.type,c.payload);"pcast.AuthenticateResponse"===c.type?this._sessionId=d.sessionId:"pcast.StreamEnded"===c.type?g.call(this,"streamEnded",[d]):"pcast.StreamDataQuality"===c.type&&g.call(this,"dataQuality",[d]);var e=this._requests[c.requestId];e&&(delete this._requests[c.requestId],"mq.Error"===c.type||"ok"!==d.status?e(void 0,d):e(d))}function k(a){this._logger.error("An error occurred",a.data)}return d.prototype.on=function(a,b){if("string"!=typeof a)throw new Error('"eventName" must be a string');if("function"!=typeof b)throw new Error('"handler" must be a function');
var c=f.call(this,a);c.push(b)},d.prototype.authenticate=function(a,b){if("string"!=typeof a)throw new Error('"authToken" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var d={apiVersion:this._mqProtocol.getApiVersion(),clientVersion:this._version,deviceId:this._deviceId,platform:c.browser,platformVersion:c.browserVersion.toString(),authenticationToken:a};return this._sessionId&&(auth.sessionId=this._sessionId),e.call(this,"pcast.Authenticate",d,b)},d.prototype.disconnect=function(){return delete this._sessionId,this._webSocket.close(1e3,"byebye")},d.prototype.bye=function(a,b){if("string"!=typeof a)throw new Error('"reason" must be a string');if("function"!=typeof b)throw new Error('"callback" must be a function');var c={sessionId:this._sessionId,reason:a};return e.call(this,"pcast.Bye",c,b)},d.prototype.setupStream=function(a,b,d,f){if("string"!=typeof a)throw new Error('"streamType" must be a string');if("string"!=typeof b)throw new Error('"streamToken" must be a string');if("object"!=typeof d)throw new Error('"options" must be an object');if("function"!=typeof f)throw new Error('"callback" must be a function');var g=c.browser||"UnknownBrowser",h=g+"-"+(c.browserVersion||0),i={streamToken:b,createStream:{sessionId:this._sessionId,options:["data-quality-notifications"],connectUri:d.connectUri,connectOptions:d.connectOptions||[]}};return d.negotiate&&(i.createStream.createOfferDescription={streamId:"",options:[a,g,h],apiVersion:this._mqProtocol.getApiVersion()}),e.call(this,"pcast.SetupStream",i,f)},d.prototype.setAnswerDescription=function(a,b,c){if("string"!=typeof a)throw new Error('"streamId" must be a string');if("string"!=typeof b)throw new Error('"sdp" must be a string');if("function"!=typeof c)throw new Error('"callback" must be a function');var d={streamId:a,sessionDescription:{type:"Answer",sdp:b},apiVersion:this._mqProtocol.getApiVersion()};return e.call(this,"pcast.SetRemoteDescription",d,c)},d.prototype.addIceCandidates=function(a,b,c,d){if("string"!=typeof a)throw new Error('"streamId" must be a string');if(!(b instanceof Array))throw new Error('"candidates" must be an array');if(!(c instanceof Array))throw new Error('"options" must be an array');if("function"!=typeof d)throw new Error('"callback" must be a function');for(var f=[],g=0;g<b.length;g++){var h=b[g];if("string"!=typeof h.candidate)throw new Error('"candidates['+g+'].candidate" must be a string');if("number"!=typeof h.sdpMLineIndex)throw new Error('"candidates['+g+'].sdpMLineIndex" must be a number');if("string"!=typeof h.sdpMid)throw new Error('"candidates['+g+'].sdpMid" must be a string');f.push({candidate:h.candidate,sdpMLineIndex:h.sdpMLineIndex,sdpMid:h.sdpMid})}var i={streamId:a,candidates:f,options:c,apiVersion:this._mqProtocol.getApiVersion()};return e.call(this,"pcast.AddIceCandidates",i,d)},d.prototype.updateStreamState=function(a,b,c,d,f){if("string"!=typeof a)throw new Error('"streamId" must be a string');if("string"!=typeof b)throw new Error('"signalingState" must be a string');if("string"!=typeof c)throw new Error('"iceGatheringState" must be a string');if("string"!=typeof d)throw new Error('"iceConnectionState" must be a string');if("function"!=typeof f)throw new Error('"callback" must be a function');var g={streamId:a,signalingState:b,iceGatheringState:c,iceConnectionState:d,apiVersion:this._mqProtocol.getApiVersion()};return e.call(this,"pcast.UpdateStreamState",g,f)},d.prototype.destroyStream=function(a,b,c){if("string"!=typeof a)throw new Error('"streamId" must be a string');if("string"!=typeof b)throw new Error('"reason" must be a string');if("function"!=typeof c)throw new Error('"callback" must be a function');var d={streamId:a,reason:b};return e.call(this,"pcast.DestroyStream",d,c)},d.prototype.toString=function(){return"PCastProtocol["+this._uri+","+this._webSocket.readyState+"]"},d}.apply(b,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c(5),c(6)],e=function(a,b){"use strict";function c(c){this._logger=c||new a;var d=b.loadJson(f);d=b.loadJson(g,d),d=b.loadJson(h,d),this._builders=d.build(),this._apiVersion=3}function d(a){for(var b=a.split("."),c=this._builders,d=0;d<b.length-1;d++)if(c=c[b[d]],!c)throw new Error('Unsupported type "'+a+'"');if(c=c[b[b.length-1]],"function"!=typeof c)throw new Error('Unsupported type "'+a+'"');return c}function e(a){if(a&&a.$type&&a.$type.children)for(var b in a.$type.children){var c=a.$type.children[b],d=a[c.name],f=c&&c.element?c.element.resolvedType:null;if(f&&"Message"===f.className&&f.children)a[c.name]=e(d);else if(f&&"Enum"===f.className&&f.children){for(var g=null,h=0;h<f.children.length;h++)if(f.children[h].id===d){g=f.children[h];break}g&&g.name&&(a[c.name]=g.name)}}return a}var f='{"package":"mq","messages":[{"name":"Request","fields":[{"rule":"optional","type":"string","name":"sessionId","id":1},{"rule":"optional","type":"string","name":"requestId","id":2},{"rule":"required","type":"string","name":"type","id":3},{"rule":"optional","type":"string","name":"encoding","id":4},{"rule":"required","type":"bytes","name":"payload","id":5}]},{"name":"Response","fields":[{"rule":"optional","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"requestId","id":2},{"rule":"required","type":"string","name":"type","id":3},{"rule":"optional","type":"string","name":"encoding","id":4},{"rule":"required","type":"bytes","name":"payload","id":5},{"rule":"repeated","type":"double","name":"wallTime","id":6}]},{"name":"Error","fields":[{"rule":"required","type":"string","name":"reason","id":1}]},{"name":"PingPong","fields":[{"rule":"required","type":"uint64","name":"originTimestamp","id":1},{"rule":"optional","type":"uint64","name":"count","id":2}]}]}',g='{"package":"pcast","messages":[{"name":"Authenticate","fields":[{"rule":"optional","type":"uint32","name":"apiVersion","id":9,"options":{"default":0}},{"rule":"required","type":"string","name":"clientVersion","id":1},{"rule":"optional","type":"string","name":"device","id":12},{"rule":"required","type":"string","name":"deviceId","id":2},{"rule":"optional","type":"string","name":"manufacturer","id":13},{"rule":"required","type":"string","name":"platform","id":3},{"rule":"required","type":"string","name":"platformVersion","id":4},{"rule":"required","type":"string","name":"authenticationToken","id":5},{"rule":"optional","type":"string","name":"connectionId","id":6},{"rule":"optional","type":"string","name":"connectionRouteKey","id":10},{"rule":"optional","type":"string","name":"remoteAddress","id":11},{"rule":"optional","type":"string","name":"sessionId","id":7},{"rule":"optional","type":"string","name":"applicationId","id":8}]},{"name":"AuthenticateResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"sessionId","id":2},{"rule":"optional","type":"string","name":"redirect","id":3},{"rule":"repeated","type":"string","name":"roles","id":4}]},{"name":"Bye","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"reason","id":2}]},{"name":"ByeResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"SessionDescription","fields":[{"rule":"required","type":"Type","name":"type","id":1,"options":{"default":"Offer"}},{"rule":"required","type":"string","name":"sdp","id":2}],"enums":[{"name":"Type","values":[{"name":"Offer","id":0},{"name":"Answer","id":1}]}]},{"name":"CreateStream","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"optional","type":"string","name":"originStreamId","id":2},{"rule":"repeated","type":"string","name":"options","id":3},{"rule":"optional","type":"string","name":"connectUri","id":8},{"rule":"repeated","type":"string","name":"connectOptions","id":9},{"rule":"repeated","type":"string","name":"tags","id":4},{"rule":"optional","type":"SetRemoteDescription","name":"setRemoteDescription","id":5},{"rule":"optional","type":"CreateOfferDescription","name":"createOfferDescription","id":6},{"rule":"optional","type":"CreateAnswerDescription","name":"createAnswerDescription","id":7}]},{"name":"CreateStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"streamId","id":2},{"rule":"optional","type":"string","name":"instanceRouteKey","id":5},{"rule":"optional","type":"SetRemoteDescriptionResponse","name":"setRemoteDescriptionResponse","id":3},{"rule":"optional","type":"CreateOfferDescriptionResponse","name":"createOfferDescriptionResponse","id":4},{"rule":"optional","type":"CreateAnswerDescriptionResponse","name":"createAnswerDescriptionResponse","id":6},{"rule":"repeated","type":"string","name":"options","id":7}]},{"name":"SetLocalDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"required","type":"SessionDescription","name":"sessionDescription","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"SetLocalDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"repeated","type":"string","name":"options","id":2}]},{"name":"SetRemoteDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"required","type":"SessionDescription","name":"sessionDescription","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"SetRemoteDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"SessionDescription","name":"sessionDescription","id":2},{"rule":"repeated","type":"string","name":"options","id":3}]},{"name":"CreateOfferDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"repeated","type":"string","name":"options","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"CreateOfferDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"SessionDescription","name":"sessionDescription","id":2},{"rule":"repeated","type":"string","name":"options","id":3}]},{"name":"CreateAnswerDescription","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"repeated","type":"string","name":"options","id":2},{"rule":"optional","type":"uint32","name":"apiVersion","id":3,"options":{"default":0}}]},{"name":"CreateAnswerDescriptionResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"SessionDescription","name":"sessionDescription","id":2},{"rule":"repeated","type":"string","name":"options","id":3}]},{"name":"IceCandidate","fields":[{"rule":"required","type":"string","name":"candidate","id":1},{"rule":"required","type":"uint32","name":"sdpMLineIndex","id":2},{"rule":"required","type":"string","name":"sdpMid","id":3}]},{"name":"AddIceCandidates","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"repeated","type":"IceCandidate","name":"candidates","id":2},{"rule":"repeated","type":"string","name":"options","id":3},{"rule":"optional","type":"uint32","name":"apiVersion","id":4,"options":{"default":0}}]},{"name":"AddIceCandidatesResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"repeated","type":"string","name":"options","id":2}]},{"name":"UpdateStreamState","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"required","type":"string","name":"signalingState","id":2},{"rule":"required","type":"string","name":"iceGatheringState","id":3},{"rule":"required","type":"string","name":"iceConnectionState","id":4},{"rule":"optional","type":"uint32","name":"apiVersion","id":5,"options":{"default":0}}]},{"name":"UpdateStreamStateResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"repeated","type":"string","name":"options","id":2}]},{"name":"DestroyStream","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"optional","type":"string","name":"reason","id":2},{"rule":"repeated","type":"string","name":"options","id":3}]},{"name":"DestroyStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"ArchiveStream","fields":[{"rule":"required","type":"string","name":"streamId","id":1},{"rule":"repeated","type":"string","name":"options","id":2}]},{"name":"ArchiveStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"uri","id":2}]},{"name":"ConnectionDisconnected","fields":[{"rule":"required","type":"string","name":"connectionId","id":1},{"rule":"required","type":"uint32","name":"reasonCode","id":2},{"rule":"optional","type":"string","name":"description","id":3}]},{"name":"ConnectionDisconnectedResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"StreamStarted","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"repeated","type":"string","name":"tags","id":3}]},{"name":"SourceStreamStarted","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"repeated","type":"string","name":"capabilities","id":3},{"rule":"repeated","type":"string","name":"tags","id":4}]},{"name":"StreamEnded","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"required","type":"string","name":"reason","id":3},{"rule":"repeated","type":"string","name":"tags","id":4}]},{"name":"SourceStreamEnded","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"required","type":"string","name":"reason","id":3},{"rule":"repeated","type":"string","name":"capabilities","id":4},{"rule":"repeated","type":"string","name":"tags","id":5}]},{"name":"StreamEndedResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"StreamIdle","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"repeated","type":"string","name":"options","id":3},{"rule":"repeated","type":"string","name":"tags","id":4}]},{"name":"StreamArchived","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"required","type":"string","name":"uri","id":3}]},{"name":"SessionEnded","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"reason","id":2},{"rule":"required","type":"float","name":"duration","id":3}]},{"name":"ForwardToClient","fields":[{"rule":"required","type":"string","name":"connectionId","id":1},{"rule":"required","type":"string","name":"type","id":2},{"rule":"required","type":"bytes","name":"payload","id":3}]},{"name":"ForwardToClientResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"SetupStream","fields":[{"rule":"required","type":"string","name":"streamToken","id":1},{"rule":"required","type":"CreateStream","name":"createStream","id":2}]},{"name":"SetupStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"CreateStreamResponse","name":"createStreamResponse","id":2}]},{"name":"SetupPlaylistStream","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamToken","id":2},{"rule":"repeated","type":"string","name":"options","id":3},{"rule":"repeated","type":"string","name":"tags","id":4}]},{"name":"PlaylistStreamManifest","fields":[{"rule":"required","type":"string","name":"manifest","id":1}]},{"name":"SetupPlaylistStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"repeated","type":"PlaylistStreamManifest","name":"manifests","id":2}]},{"name":"StreamDataQuality","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"streamId","id":2},{"rule":"required","type":"uint64","name":"timestamp","id":3},{"rule":"required","type":"DataQualityStatus","name":"status","id":4},{"rule":"required","type":"DataQualityReason","name":"reason","id":5}],"enums":[{"name":"DataQualityStatus","values":[{"name":"NoData","id":0},{"name":"AudioOnly","id":1},{"name":"All","id":2}]},{"name":"DataQualityReason","values":[{"name":"None","id":0},{"name":"UploadLimited","id":1},{"name":"DownloadLimited","id":2},{"name":"PublisherLimited","id":3},{"name":"NetworkLimited","id":4}]}]},{"name":"StreamDataQualityResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"CallbackEvent","fields":[{"rule":"optional","type":"uint32","name":"apiVersion","id":1,"options":{"default":0}},{"rule":"required","type":"string","name":"entity","id":2},{"rule":"required","type":"string","name":"what","id":3},{"rule":"required","type":"string","name":"data","id":4},{"rule":"optional","type":"string","name":"sessionId","id":5}]},{"name":"Uri","fields":[{"rule":"optional","type":"string","name":"protocol","id":1,"options":{"default":"http"}},{"rule":"required","type":"string","name":"host","id":2},{"rule":"optional","type":"uint32","name":"port","id":3,"options":{"default":80}},{"rule":"optional","type":"string","name":"method","id":4,"options":{"default":"POST"}},{"rule":"optional","type":"string","name":"path","id":5,"options":{"default":"/"}}]},{"name":"SetApplicationCallback","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"required","type":"Uri","name":"callback","id":3}]},{"name":"SetApplicationCallbackResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"IssueAuthenticationToken","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"repeated","type":"string","name":"capabilities","id":3}]},{"name":"IssueAuthenticationTokenResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"authenticationToken","id":2}]},{"name":"IssueStreamToken","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"required","type":"string","name":"sessionId","id":3},{"rule":"optional","type":"string","name":"originStreamId","id":4},{"rule":"repeated","type":"string","name":"capabilities","id":5}]},{"name":"IssueStreamTokenResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"streamToken","id":2}]},{"name":"TerminateStream","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"required","type":"string","name":"streamId","id":3},{"rule":"optional","type":"string","name":"reason","id":4}]},{"name":"TerminateStreamResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"Stream","fields":[{"rule":"required","type":"string","name":"streamId","id":1}]},{"name":"ListStreams","fields":[{"rule":"required","type":"string","name":"applicationId","id":1},{"rule":"required","type":"string","name":"secret","id":2},{"rule":"optional","type":"string","name":"start","id":3},{"rule":"required","type":"uint32","name":"length","id":4},{"rule":"repeated","type":"string","name":"options","id":5}]},{"name":"ListStreamsResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"start","id":2},{"rule":"optional","type":"uint32","name":"length","id":3},{"rule":"repeated","type":"Stream","name":"streams","id":4}]}]}',h='{"package":"chat","messages":[{"name":"Room","fields":[{"rule":"optional","type":"string","name":"roomId","id":1},{"rule":"required","type":"string","name":"name","id":2},{"rule":"required","type":"string","name":"description","id":3},{"rule":"required","type":"RoomType","name":"type","id":4},{"rule":"repeated","type":"string","name":"options","id":5}]},{"name":"Stream","fields":[{"rule":"required","type":"StreamType","name":"type","id":1},{"rule":"required","type":"string","name":"uri","id":2},{"rule":"required","type":"TrackState","name":"audioState","id":3},{"rule":"required","type":"TrackState","name":"videoState","id":4}]},{"name":"Member","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"screenName","id":2},{"rule":"required","type":"MemberRole","name":"role","id":3},{"rule":"repeated","type":"Stream","name":"streams","id":4},{"rule":"required","type":"uint64","name":"lastUpdate","id":7}]},{"name":"CreateRoom","fields":[{"rule":"required","type":"Room","name":"room","id":1}]},{"name":"CreateRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"string","name":"roomId","id":2}]},{"name":"JoinRoom","fields":[{"rule":"required","type":"string","name":"roomId","id":1},{"rule":"required","type":"string","name":"sessionId","id":2},{"rule":"required","type":"Member","name":"member","id":3},{"rule":"repeated","type":"string","name":"options","id":4},{"rule":"required","type":"uint64","name":"timestamp","id":5}]},{"name":"JoinRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1},{"rule":"optional","type":"Room","name":"room","id":2},{"rule":"repeated","type":"Member","name":"members","id":3},{"rule":"repeated","type":"string","name":"options","id":4}]},{"name":"UpdateRoom","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"Room","name":"room","id":2},{"rule":"required","type":"uint64","name":"timestamp","id":3}]},{"name":"UpdateRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"UpdateMember","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"Member","name":"member","id":2},{"rule":"repeated","type":"string","name":"options","id":3},{"rule":"required","type":"uint64","name":"timestamp","id":4}]},{"name":"UpdateMemberResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"LeaveRoom","fields":[{"rule":"required","type":"string","name":"roomId","id":1},{"rule":"required","type":"string","name":"sessionId","id":2},{"rule":"required","type":"uint64","name":"timestamp","id":3}]},{"name":"LeaveRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"DestroyRoom","fields":[{"rule":"required","type":"string","name":"roomId","id":1}]},{"name":"DestroyRoomResponse","fields":[{"rule":"required","type":"string","name":"status","id":1}]},{"name":"RoomEvent","fields":[{"rule":"required","type":"string","name":"sessionId","id":1},{"rule":"required","type":"string","name":"roomId","id":2},{"rule":"required","type":"RoomEventType","name":"eventType","id":3},{"rule":"repeated","type":"Member","name":"members","id":4},{"rule":"optional","type":"Room","name":"room","id":5},{"rule":"repeated","type":"string","name":"options","id":6},{"rule":"required","type":"uint64","name":"timestamp","id":7}]}],"enums":[{"name":"RoomType","values":[{"name":"DirectChat","id":0},{"name":"MultiPartyChat","id":1},{"name":"ModeratedChat","id":2},{"name":"TownHall","id":3}]},{"name":"MemberRole","values":[{"name":"Participant","id":0},{"name":"Moderator","id":1},{"name":"Presenter","id":2},{"name":"Audience","id":3}]},{"name":"RoomEventType","values":[{"name":"MemberJoined","id":0},{"name":"MemberLeft","id":1},{"name":"MemberUpdated","id":2},{"name":"Updated","id":3},{"name":"Ended","id":4}]},{"name":"TrackState","values":[{"name":"Enabled","id":0},{"name":"Disabled","id":1},{"name":"Ended","id":2}]},{"name":"StreamType","values":[{"name":"User","id":0},{"name":"Presentation","id":1}]}]}';return c.prototype.getApiVersion=function(){return this._apiVersion},c.prototype.encode=function(a,b){if("string"!=typeof a)throw new Error("'type' must be a string");if("object"!=typeof b)throw new Error("'data' must be an object");var c=d.call(this,a);return c.encode(b)},c.prototype.decode=function(a,b){if("string"!=typeof a)throw new Error("'type' must be a string");var c=d.call(this,a);return e(c.decode(b))},c}.apply(b,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[],e=function(){"use strict";function a(){}var b=function(){console.log.apply(console,arguments)}||function(){},c=function(){console.error.apply(console,arguments)}||b;return a.prototype.trace=function(){return b(arguments)},a.prototype.debug=function(){return b(arguments)},a.prototype.info=function(){return b(arguments)},a.prototype.warn=function(){return c(arguments)},a.prototype.error=function(){return c(arguments)},a.prototype.fatal=function(){return c(arguments)},a}.apply(b,d),!(void 0!==e&&(a.exports=e))},function(a,c){a.exports=b},function(a,b){a.exports=c},function(a,b,c){var d,e;d=[c(9),c(10)],e=function(a,b){"use strict";function c(a,c,d){if("string"!=typeof a)throw new Error('Must pass a valid "version"');if("string"!=typeof c)throw new Error('Must pass a valid "baseUri"');if("object"!=typeof d)throw new Error('Must pass a valid "logger"');this._version=a,this._baseUri=c,this._logger=d,this._http=new b(a,c,d)}function d(b,c){if(0===b.lastIndexOf("wss:",0))c(void 0,b+"/ws");else if(0===b.lastIndexOf("https:",0)){var d=this;e.call(d,b,function(b,e){if(b)return c(b);var f=new a(c,d._version,d._baseUri,d._logger);f.resolveAll(e)})}else c(new Error("Uri not supported"))}function e(a,b){this._http.httpGetWithRetry(a+"/pcast/endPoints",function(a,c){if(a)return b(new Error("Failed to resolve an end point",a));var d=c.split(",");d.length<1&&b(new Error("Failed to discover end points")),b(void 0,d)},f)}var f=3;return c.DefaultPCastUri="https://pcast.phenixp2p.com",c.prototype.getBaseUri=function(){return this._baseUri},c.prototype.resolveUri=function(a){return d.call(this,this._baseUri,a)},c.prototype.toString=function(){return"PCastEndPoint["+this._baseUri+"]"},c}.apply(b,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c(10),c(11)],e=function(a,b){"use strict";function c(b,c,d,e){this._done=!1,this._minTime=Number.MAX_VALUE,this._minResponseText="",this._onClosestEndpointFound=b,this._logger=e,this._version=c,this._http=new a(c,d,e)}var d=4;return c.prototype.isResolved=function(){return this._done},c.prototype.measurementCallback=function(a,b,c){return b<this._minTime&&(this._logger.info("Current closest end point is [%s] with latency of [%s] ms",c,b),this._minTime=b,this._minResponseText=c),this.isResolved()},c.prototype.completeCallback=function(a){if(this._minResponseText&&this._minTime<Number.MAX_VALUE&&!this.isResolved())return this._done=!0,this._onClosestEndpointFound(void 0,this._minResponseText)},c.prototype.resolveAll=function(a){for(var b=0;b<a.length;b++)this.resolve(a[b],d)},c.prototype.resolve=function(a,c){var d=this,e=1,f=function g(a){var f=1,h=b.now();d._logger.info("[%s] Checking end point [%s]",e,a),d._http.httpGetWithRetry.call(d,a,function(f,i){var j=b.now(),k=j-h;if(d._logger.info("[%s] End point [%s] latency is [%s] ms",e,a,k),e++,f||!d.measurementCallback(a,k,i))return e<=c&&!d.isResolved()?(f&&d._logger.info("Retrying after failure to resolve end point [%s]",a,f),g(a)):d.completeCallback(a)},f)};f(a)},c}.apply(b,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c(11)],e=function(a){"use strict";function b(a,b,c){if("string"!=typeof a)throw new Error('Must pass a valid "version"');if("string"!=typeof b)throw new Error('Must pass a valid "baseUri"');if("object"!=typeof c)throw new Error('Must pass a valid "logger"');this._version=a,this._baseUri=b,this._logger=c}return b.prototype.httpGetWithRetry=function c(b,d,e,f){void 0===f&&(f=1);var g=this,h=new XMLHttpRequest,i="GET",j=b+"?version="+encodeURIComponent(g._version)+"&_="+a.now();if("withCredentials"in h)h.open(i,j,!0);else if("undefined"!=typeof XDomainRequest)h=new XDomainRequest,h.open(i,j);else{var k=new Error("unsupported");k.code="unsupported",d(k)}h.addEventListener("readystatechange",function(){if(4===h.readyState)if(200===h.status)d(void 0,h.responseText);else if(h.status>=500&&h.status<600&&f<=e)c.call(g,b,d,e,f+1);else{g._logger.info("HTTP GET [%s] failed with [%s] [%s]",b,h.status,h.statusText);var a=new Error(0===h.status?"timeout":h.statusText);a.code=h.status,d(a)}}),h.timeout=15e3,h.send()},b}.apply(b,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[],e=function(){"use strict";function a(){this._version=version,this._baseUri=baseUri}return a.now=function(){return Date.now?function(){return Date.now()}:function(){return(new Date).getTime()}}(),a}.apply(b,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[c(11),c(1)],e=function(a,b){"use strict";function c(a,b,c){if("string"!=typeof a)throw new Error('Must pass a valid "name"');if("object"!=typeof b)throw new Error('Must pass a valid "peerConnection"');if("object"!=typeof c)throw new Error('Must pass a valid "logger"');this._name=a,this._peerConnection=b,this._logger=c}function d(c,d,e,o,p){function q(){var i=null;f(d,i,function(f){function i(d,f){switch(b.browser){case"Firefox":if(n=m|=d.selected&&"succeeded"===d.state,"outbound"===e.direction&&"outboundrtp"===d.type){var g={time:a.now(),value:d.bytesSent||0};switch(d.mediaType){case"video":r._logger.debug("[%s] Outbound [%s] [%s] with bitrate [%s], droppedFrames [%s] and frame rate [%s]",c,d.mediaType,d.ssrc,d.bitrateMean,d.droppedFrames,d.framerateMean),j=!0,t=d.framerateMean||0,k=!0,u=h(g,w),w=g;break;case"audio":r._logger.debug("[%s] Outbound [%s] [%s]",c,d.mediaType,d.ssrc),l=!0,v=h(g,x),x=g}}if("inbound"===e.direction&&"inboundrtp"===d.type){var g={time:a.now(),value:d.bytesReceived||0};switch(d.mediaType){case"video":r._logger.debug("[%s] Inbound [%s] [%s] with framerate [%s] and jitter [%s]",c,d.mediaType,d.ssrc,d.framerateMean,d.jitter),k=!0,u=h(g,w),w=g;break;case"audio":r._logger.debug("[%s] Inbound [%s] [%s] with jitter [%s]",c,d.mediaType,d.ssrc,d.jitter),l=!0,v=h(g,x),x=g}}break;default:if("true"===d.googWritable&&(n=!0),"true"===d.googReadable&&(m=!0),"ssrc"!==d.type)return;if("outbound"===e.direction){var g={time:a.now(),value:d.bytesSent||0};switch(d.mediaType){case"video":r._logger.debug("[%s] Outbound [%s] [%s] with average encoding time [%s] ms (CPU limited=[%s]) and RTT [%s]",c,d.mediaType,d.ssrc,d.googAvgEncodeMs,d.googCpuLimitedResolution,d.googRtt),j=!0,t=d.googFrameRateSent||0,k=!0,u=h(g,w),w=g;break;case"audio":r._logger.debug("[%s] Outbound [%s] [%s] with audio input level [%s] and RTT [%s] and jitter [%s]",c,d.mediaType,d.ssrc,d.audioInputLevel,d.googRtt,d.googJitterReceived),l=!0,v=h(g,x),x=g}}else if("inbound"===e.direction){var g={time:a.now(),value:d.bytesReceived||0};switch(d.mediaType){case"video":r._logger.debug("[%s] Inbound [%s] [%s] with current delay [%s] ms and target delay [%s] ms",c,d.mediaType,d.ssrc,d.googCurrentDelayMs,d.googTargetDelayMs),j=!0,t=d.googFrameRateReceived||0,k=!0,u=h(g,w),w=g;break;case"audio":r._logger.debug("[%s] Inbound [%s] [%s] with output level [%s] and jitter [%s] and jitter buffer [%s] ms",c,d.mediaType,d.ssrc,d.audioOutputLevel,d.googJitterReceived,d.googJitterBufferMs),l=!0,v=h(g,x),x=g}}}}var j=!1,k=!1,l=!1,m=!1,n=!1;if(f.forEach)f.forEach(i);else for(var H in f){var I=f[H];i(I,H)}if(k&&0===u||l&&0===v||j&&0===t){var J=g.call(r,d);k=k&&J.video&&J.video.enabled!==!1,l=l&&J.audio&&J.audio.enabled!==!1,j=j&&J.video&&J.video.enabled!==!1,
m=m||!(J.video&&J.video.enabled!==!1||J.audio&&J.audio.enabled!==!1),n=n||!(J.video&&J.video.enabled!==!1||J.audio&&J.audio.enabled!==!1)}if((l||k||j)&&r._logger.debug("[%s] Current bit rate is [%s] bps for audio and [%s] bps for video with [%s] FPS",c,Math.ceil(v||0),Math.ceil(u||0),t||"?"),!o())return void r._logger.info("[%s] Finished monitoring of peer connection",c);if(!G||"closed"!==d.connectionState&&"failed"!==d.connectionState&&"failed"!==d.iceConnectionState)E&&j&&t<=y?s++:F&&l&&v<=A?s++:F&&k&&u<=z?s++:m&&n?s=0:s++;else{var J=g.call(r,d),K=0,L=0;for(var M in J){var N=J[M];N&&N.enabled!==!1?K++:L++}if(0===K&&L>0)return void r._logger.info("[%s] Finished monitoring of peer connection with [%s] inactive tracks",c,L);s++}s>=B?p("condition",t,u,v)?(s=Number.MIN_VALUE,setTimeout(q,C)):r._logger.error("[%s] Failure detected with frame rate [%s] FPS and bit rate [%s/%s] bps: [%s]",c,t,v,u,f):setTimeout(q,s>0?D:C)},function(a){p("error",a)})}if("string"!=typeof c)throw new Error('Must pass a valid "name"');if("object"!=typeof d)throw new Error('Must pass a valid "peerConnection"');if("object"!=typeof e)throw new Error('Must pass a valid "options"');if("function"!=typeof o)throw new Error('Must pass a valid "activeCallback"');if("function"!=typeof p)throw new Error('Must pass a valid "monitorCallback"');if("inbound"!==e.direction&&"outbound"!==e.direction)throw new Error("Invalid monitoring direction");var r=this,s=0,t=void 0,u=void 0,v=void 0,w={time:a.now(),value:0},x={time:a.now(),value:0},y=e.frameRateThreshold||k,z=e.videoBitRateThreshold||m,A=e.audioBitRateThreshold||l,B=e.conditionCountForNotificationThreshold||n,C=e.monitoringInterval||i,D=e.monitoringInterval||j,E=!e.hasOwnProperty("monitorFrameRate")||e.monitorFrameRate,F=!e.hasOwnProperty("monitorBitRate")||e.monitorBitRate,G=!e.hasOwnProperty("monitorState")||e.monitorState;setTimeout(q,C)}function e(a){if("Firefox"===b.browser)return a;var c={};return a.result().forEach(function(a){var b={id:a.id,type:a.type};a.names().forEach(function(c){b[c]=a.stat(c)}),c[b.id]=b}),c}function f(a,c,d,f){switch(b.browser){case"Firefox":return a.getStats(c).then(function(a){var b=e(a);d(b)})["catch"](function(a){f("error",a)});default:return a.getStats(function(a){var b=e(a);d(b)},c,function(a){f("error",a)})}}function g(a){var b={},c=a.localDescription.sdp.split("m="),d=a.remoteDescription.sdp.split("m=");if(c.length!==d.length)return{};for(var e=1;e<c.length;e++){var f=c[e];f.startsWith("audio")?b.audio={enabled:f.indexOf("a=inactive")===-1&&d[e].indexOf("a=inactive")===-1}:f.startsWith("video")&&(b.video={enabled:f.indexOf("a=inactive")===-1&&d[e].indexOf("a=inactive")===-1})}return b}function h(a,b){return 8*(a.value-b.value)/((a.time-b.time)/1e3)}var i=4e3,j=1500,k=2,l=5e3,m=6e3,n=3;return c.prototype.start=function(a,b,c){return d.call(this,this._name,this._peerConnection,a,b,c)},c.prototype.toString=function(){return"PeerConnectionMonitor[]"},c}.apply(b,d),!(void 0!==e&&(a.exports=e))},function(a,b,c){var d,e;d=[],e=function(){"use strict";function a(a){if(!a)throw new Error("'logger' must be specified.");this._logger=a,this._dimensionsChangedIntervalId=null,this._videoDisplayDimensionsChangedCallback=null,this._toBeStarted=!1,this._videoElement=null,this._dimensionsChangedData={pollFrequency:f,previousWidth:0,previousHeight:0},this._renderer=null}function b(a,b){b&&void 0!==b.videoWidth||this._logger.warn("Attempting to start dimensions changed monitor without providing proper 'video' element."),this._renderer=a,this._videoElement=b,this._toBeStarted=!0,e.call(this)}function c(){this._toBeStarted=!1,this._dimensionsChangedIntervalId&&(clearInterval(this._dimensionsChangedIntervalId),this._dimensionsChangedIntervalId=null)}function d(a,b){if(null===a)return this._videoDisplayDimensionsChangedCallback=null,void c.call(this);if("function"!=typeof a)throw new Error('"callback" must be a function');this._videoDisplayDimensionsChangedCallback=a,b&&b.pollFrequency&&(this._dimensionsChangedData.pollFrequency=b.pollFrequency>=g?b.pollFrequency:g),e.call(this)}function e(){if(this._toBeStarted&&!this._dimensionsChangedIntervalId&&this._videoDisplayDimensionsChangedCallback){var a=this;this._dimensionsChangedData.previousWidth=this._videoElement.videoWidth,this._dimensionsChangedData.previousHeight=this._videoElement.videoHeight,this._dimensionsChangedIntervalId=setInterval(function(){a._videoElement.videoWidth===a._dimensionsChangedData.previousWidth&&a._videoElement.videoHeight===a._dimensionsChangedData.previousHeight||(a._dimensionsChangedData.previousWidth=a._videoElement.videoWidth,a._dimensionsChangedData.previousHeight=a._videoElement.videoHeight,a._videoDisplayDimensionsChangedCallback(a._renderer,{width:a._videoElement.videoWidth,height:a._videoElement.videoHeight}))},a._dimensionsChangedData.pollFrequency)}}var f=500,g=15;return a.prototype.start=function(a,c){b.call(this,a,c)},a.prototype.stop=function(){c.call(this)},a.prototype.setVideoDisplayDimensionsChangedCallback=function(a,b){d.call(this,a,b)},a.prototype.toString=function(){return"DimensionsChangedMonitor[pollFrequency="+this._dimensionsChangedData.pollFrequency+", previousHeight="+this._dimensionsChangedData.previousHeight+", previousWidth="+this._dimensionsChangedData.previousHeight+", state="+(this._dimensionsChangedIntervalId?"running":"stopped")+"]"},a}.apply(b,d),!(void 0!==e&&(a.exports=e))}])});